<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  
    <meta name="keywords" content="android">
  
  
    <meta name="description" content="三流执行工程师">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    深度集成使用高德地图功能--猎鹰（1）   记录轨迹篇 |
    
    清河阳</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  <article id="post-深度集成使用高德地图功能-猎鹰" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      深度集成使用高德地图功能--猎鹰（1）   记录轨迹篇
    </h1>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/1ca89d06.html" class="article-date">
  <time datetime="2020-01-06T13:29:00.000Z" itemprop="datePublished">2020-01-06</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <p>本文适用对象：已继承了猎鹰功能的朋友及使用期间遇到困难的朋友。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>前段日子公司要求上线一个功能，具有导航，记录轨迹，查看历史行程等功能的一个模块，我用过百度地图，但是公司继承的是高德地图，索性直接用高德，其实我对百度观感也极差，理由就是–作恶多端。<br>功能是要做的，时间也很急，12月上旬左右说的需求，还没有UI图，要求年底前上线，我们大概7个移动端开发人员，全都上了，我主要负责的就是记点，记轨迹，查轨迹的功能，其中遇到了很多很多坑，也算是一种提升吧。  </p>
<hr>
<h1 id="过程-amp-难点"><a href="#过程-amp-难点" class="headerlink" title="过程&amp;难点"></a>过程&amp;难点</h1><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>技术选型预研阶段，与后台考虑过是否自己上传点位，报告位置，一开始是这么选的，后来感觉对于流量还有并发等问题，也是碰巧遇到了高德的猎鹰，研究了下，就直接用人家的接口了，总比花自己的流量要实惠。<br>于是乎我就负责了猎鹰的继承，然后还要帮助同事写一点接口，本文没有关于视图层的东西。</p>
<h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><p>遇到了挺多的难点，其实继承第三方并不困难，困难的就在于，第三方有可能文档不全，这是个问题。<br>我在期间遇到了挺多难题，总结一下吧。<br>记录轨迹的难题有：  </p>
<blockquote>
<ul>
<li>记录点位不全  </li>
<li>内存泄漏的问题  </li>
<li>8.0以上系统后台定位被限制住  </li>
</ul>
</blockquote>
<p>闲话不多说，直接上代码。  </p>
<hr>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'com.amap.api:navi-3dmap:latest.integration'</span></span><br><span class="line">implementation <span class="string">'com.amap.api:search:latest.integration'</span></span><br><span class="line">implementation <span class="string">'org.greenrobot:eventbus:3.1.1'</span></span><br><span class="line">implementation files(<span class="string">'libs/AMapTrack_1.1.0_AMapLocation_4.8.0_20191210.jar'</span>)</span><br></pre></td></tr></table></figure>
<p>继承猎鹰功能必须用jar包形式， <strong>jar包里面顺道包含了定位的sdk，所以不用在二次依赖定位的sdk</strong> ，不然会报错。<br>信息传递使用的是EventBus。</p>
<h2 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h2><p>实体类如下，用于被EventBus传递信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrackInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> terminalId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> trackId;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> canUse;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCanUse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> canUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCanUse</span><span class="params">(<span class="keyword">boolean</span> canUse)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.canUse = canUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTerminalId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> terminalId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTerminalId</span><span class="params">(<span class="keyword">long</span> terminalId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTrackId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> trackId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTrackId</span><span class="params">(<span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.trackId = trackId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="轨迹服务"><a href="#轨迹服务" class="headerlink" title="轨迹服务"></a>轨迹服务</h2><p>官方已经给了启动顺序，我简化了下，根据他的demo也改了下，启动顺序是这样的：  </p>
<blockquote>
<ol>
<li>新建TerminalId,使用QueryTerminalRequest，传入serviceId、terminalName，如果得到terminalId不为0，去往第3步；为0，去第2步。  </li>
<li>因为terminalId=0，所以是一个新的设备，调用AddTerminalRequest，传入serviceId、terminalName，得到terminalId。</li>
<li>根据上一步的回调得到terminalId，调用AddTrackRequest，传入serviceId、terminalId，得到trackId。  </li>
<li>三个id都得到后，可以根据官方api，调用 client.startTrack（）方法，启动轨迹。  </li>
<li>启动轨迹后，在成功的回调里，调用client.startGather（）方法，启动收集点位。  </li>
</ol>
</blockquote>
<p>几步代码如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建路线</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> serviceId</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> terminalName</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> trackId</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTrack</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> serviceId, <span class="keyword">final</span> String terminalName, <span class="keyword">final</span> <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.serviceId = serviceId;</span><br><span class="line">      <span class="keyword">this</span>.trackId = trackId;</span><br><span class="line">      client.queryTerminal(<span class="keyword">new</span> QueryTerminalRequest(serviceId, terminalName), <span class="keyword">new</span> SimpleOnTrackListener() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryTerminalCallback</span><span class="params">(QueryTerminalResponse queryTerminalResponse)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (queryTerminalResponse.isSuccess()) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (queryTerminalResponse.getTid() &lt;= <span class="number">0</span>) &#123;<span class="comment">//新用户去申请terminalId</span></span><br><span class="line">                      addTerminal(serviceId, terminalName, trackId);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">long</span> terminalId = queryTerminalResponse.getTid();<span class="comment">//老用户直接获取terminalId</span></span><br><span class="line">                      <span class="keyword">if</span> (trackId != <span class="number">0</span>) &#123;<span class="comment">//此处为断点续传//如果有trackId，则直接返回成功，去startGather</span></span><br><span class="line">                          <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                              trackDoSthListener.onCreateTrackSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                              onTrackListenerNull();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;<span class="comment">//为0为新的</span></span><br><span class="line">                          createTrack(serviceId, terminalId);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onDoingFailed(queryTerminalResponse.getErrorMsg(), queryTerminalResponse.getErrorCode(), <span class="string">"查询Terminal"</span>);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 新建terminal</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> serviceId</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> terminalName</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> trackId</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTerminal</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> serviceId, String terminalName, <span class="keyword">final</span> <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">      client.addTerminal(<span class="keyword">new</span> AddTerminalRequest(terminalName, serviceId), <span class="keyword">new</span> SimpleOnTrackListener() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTerminalCallback</span><span class="params">(AddTerminalResponse addTerminalResponse)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (addTerminalResponse.isSuccess()) &#123;</span><br><span class="line">                  <span class="keyword">long</span> terminalId = addTerminalResponse.getTid();</span><br><span class="line">                  TrackFactory.<span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">                  <span class="keyword">if</span> (trackId != <span class="number">0</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onCreateTrackSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      createTrack(serviceId, terminalId);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onDoingFailed(addTerminalResponse.getErrorMsg(), addTerminalResponse.getErrorCode(), <span class="string">"新建Terminal"</span>);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 重写方法</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> serviceId</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> terminalId</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createTrack</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> serviceId, <span class="keyword">final</span> <span class="keyword">long</span> terminalId)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">      client.addTrack(<span class="keyword">new</span> AddTrackRequest(serviceId, terminalId), <span class="keyword">new</span> SimpleOnTrackListener() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAddTrackCallback</span><span class="params">(AddTrackResponse addTrackResponse)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (addTrackResponse.isSuccess()) &#123;</span><br><span class="line">                  trackId = addTrackResponse.getTrid();</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onCreateTrackSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onDoingFailed(addTrackResponse.getErrorMsg(), addTrackResponse.getErrorCode(), <span class="string">"新建Track"</span>);</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>如果收集完毕，轨迹停止顺序为下：  </p>
<blockquote>
<ol>
<li>调用官方api，client.stopGather()，停止收集点位。  </li>
<li>得到停止收集点位成功的回调里，调用client.stopTrack()，停止定位服务。  </li>
</ol>
</blockquote>
<p>值得注意的是，开始的时候是<strong>先启动track，在启动gather。而停止的时候正好是反着的，先停止gather，在停止track，</strong>不要搞反。  </p>
<p>三个Id分别为：serviceId,terminalId,trackId，是核心的东西，需要传给后台服务器，供以后查询使用。<br>猎鹰生命周期如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动猎鹰生命周期回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">newListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        listener = <span class="keyword">new</span> OnTrackLifecycleListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindServiceCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartGatherCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.START_GATHER_SUCEE ||</span><br><span class="line">                        i == ErrorCode.TrackListen.START_GATHER_ALREADY_STARTED) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onStartSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, <span class="number">0</span>, <span class="string">"定位开始收集失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartTrackCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.START_TRACK_SUCEE ||</span><br><span class="line">                        i == ErrorCode.TrackListen.START_TRACK_SUCEE_NO_NETWORK ||</span><br><span class="line">                        i == ErrorCode.TrackListen.START_TRACK_ALREADY_STARTED) &#123;</span><br><span class="line">                    <span class="comment">// 服务启动成功，继续开启收集上报</span></span><br><span class="line">                    client.startGather(<span class="keyword">this</span>);</span><br><span class="line">                    <span class="comment">//ToastUtil.getInstance()._short(context, "开始路程成功");</span></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, <span class="number">0</span>, <span class="string">"Track服务启动失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopGatherCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.STOP_GATHER_SUCCE) &#123;</span><br><span class="line">                    TrackParam tp = <span class="keyword">new</span> TrackParam(serviceId, terminalId);</span><br><span class="line">                    client.stopTrack(tp, listener);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, i, <span class="string">"定位停止采集失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopTrackCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.STOP_TRACK_SUCCE) &#123;</span><br><span class="line">                    <span class="comment">// 成功停止</span></span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onStopSuccess();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, i, <span class="string">"路程停止失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面大概就是猎鹰功能的核心代码，很多都没写全，本想着开一篇就够了，但是感觉篇幅太长，就算了。  </p>
<h2 id="前台服务"><a href="#前台服务" class="headerlink" title="前台服务"></a>前台服务</h2><p>猎鹰功能本身是自己带着service的，但是如果一直处在后台状态，会被杀死，尤其是Android 8.0以后，限制住了很多权限，其中就有后台定位功能。<br>猎鹰推荐8.0系统启动一个 ForcegroundService，新出的前台进程，也可以给他们的api传一个notification，让他们自己启动前台进程，但是有一个问题，就是他们的接口已经过时了，不能用了，于是我研究了下，就自己写了一个前台Service来确保猎鹰可以正常取点。<br>我在其中做了个media Player来确保尽可能不被后台杀死。<br><strong>在单例里面用四大组件的上下文一定要特别注意，最好传getApplicationContext()，因为Application的上下文是能贯穿整个app的</strong>，我一开始因为失误，再单例里面传了Service的上下文，导致service一直无法被回收，导致内存泄漏。<br>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ************************************************************</span></span><br><span class="line"><span class="comment"> * 文件：CarManageService.java  模块：app  项目：oemp-android</span></span><br><span class="line"><span class="comment"> * 当前修改时间：2019年12月25日 09:57:10</span></span><br><span class="line"><span class="comment"> * 上次修改时间：2019年12月25日 09:57:10</span></span><br><span class="line"><span class="comment"> * 作者：QingHeyang</span></span><br><span class="line"><span class="comment"> * QingHeyang版权所有</span></span><br><span class="line"><span class="comment"> * ************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.qhy.trackdemo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Notification;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationChannel;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationManager;</span><br><span class="line"><span class="keyword">import</span> android.app.PendingIntent;</span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.BitmapDrawable;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaPlayer;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.qhy.trackdemo.MainActivity;</span><br><span class="line"><span class="keyword">import</span> com.qhy.trackdemo.R;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.EventBus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrackDemoService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHANNEL_ID_SERVICE_RUNNING = <span class="string">"CHANNEL_ID_SERVICE_RUNNING"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> serviceId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> terminalId, trackId;</span><br><span class="line">    <span class="keyword">private</span> String terminalName;</span><br><span class="line">    <span class="keyword">private</span> Notification notification;</span><br><span class="line">    <span class="keyword">private</span> MediaPlayer bgmediaPlayer;</span><br><span class="line">    <span class="keyword">private</span> Intent intent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Notification notification = registerNotification();</span><br><span class="line">        <span class="keyword">this</span>.notification = notification;</span><br><span class="line">       <span class="comment">// BaseApplication.getRefWatcher().watch(this);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.intent = intent;</span><br><span class="line">            startGather(intent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> START_REDELIVER_INTENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册用于8.0以后的手机</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Notification <span class="title">registerNotification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Notification.Builder builder;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">            NotificationManager nm = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line">            NotificationChannel channel = <span class="keyword">new</span> NotificationChannel(CHANNEL_ID_SERVICE_RUNNING</span><br><span class="line">                    , <span class="string">"猎鹰服务"</span></span><br><span class="line">                    , NotificationManager.IMPORTANCE_LOW);</span><br><span class="line">            nm.createNotificationChannel(channel);</span><br><span class="line">            builder = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>, CHANNEL_ID_SERVICE_RUNNING);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Intent nfIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class);<span class="comment">//此处的Activity为前台进程的Notification点击回调页面</span></span><br><span class="line">        nfIntent.putExtra(<span class="string">"fromService"</span>, <span class="keyword">true</span>);</span><br><span class="line">        Bitmap bitmap = ((BitmapDrawable) getResources().getDrawable(R.mipmap.ic_launcher)).getBitmap();<span class="comment">//此处icon需要根据自己需求来</span></span><br><span class="line">        builder.setContentIntent(PendingIntent.getActivity(<span class="keyword">this</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                nfIntent, PendingIntent.FLAG_UPDATE_CURRENT))</span><br><span class="line">                .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">                .setLargeIcon(bitmap)</span><br><span class="line">                .setContentTitle(<span class="string">"您的有未完成的行程进行中..."</span>)</span><br><span class="line">                .setContentText(<span class="string">"点击回到行程"</span>);</span><br><span class="line">        Notification notification = builder.build();</span><br><span class="line">        <span class="keyword">return</span> notification;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始收集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> intent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startGather</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        terminalName = intent.getStringExtra(<span class="string">"terminalName"</span>);</span><br><span class="line">        trackId = intent.getLongExtra(<span class="string">"trackId"</span>, <span class="number">0</span>);</span><br><span class="line">        serviceId = intent.getLongExtra(<span class="string">"serviceId"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*Notification notification =  registerNotification();</span></span><br><span class="line"><span class="comment">        startForeground((int) System.currentTimeMillis(),notification);*/</span></span><br><span class="line"></span><br><span class="line">        TrackFactory.getInstance(getApplicationContext()).setOnTrackDoSthListener(<span class="keyword">new</span> TrackFactory.OnTrackDoSthListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTrackSuccess</span><span class="params">(<span class="keyword">long</span> serviceId, <span class="keyword">long</span> terminalId, <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">                TrackDemoService.<span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">                TrackDemoService.<span class="keyword">this</span>.trackId = trackId;</span><br><span class="line">                TrackFactory.getInstance(TrackDemoService.<span class="keyword">this</span>.getApplicationContext()).startGather(serviceId, terminalId, trackId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartSuccess</span><span class="params">(<span class="keyword">long</span> serviceId, <span class="keyword">long</span> terminalId, <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">                TrackInfo info = <span class="keyword">new</span> TrackInfo();</span><br><span class="line">                info.setTrackId(trackId);</span><br><span class="line">                info.setTerminalId(terminalId);</span><br><span class="line">                info.setCanUse(<span class="keyword">true</span>);</span><br><span class="line">                EventBus.getDefault().post(info);</span><br><span class="line">                startForeground((<span class="keyword">int</span>) System.currentTimeMillis(), notification);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDoingFailed</span><span class="params">(String msg, <span class="keyword">long</span> code, String from)</span> </span>&#123;</span><br><span class="line">                TrackInfo info = <span class="keyword">new</span> TrackInfo();</span><br><span class="line">                info.setMessage(msg + <span class="string">"\n"</span> + from);</span><br><span class="line">                info.setCanUse(<span class="keyword">false</span>);</span><br><span class="line">                EventBus.getDefault().post(info);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        TrackFactory.getInstance(getApplicationContext()).createTrack(serviceId, terminalName, trackId);</span><br><span class="line">        playMusic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此处播放无声音乐，用来不被系统杀死</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">playMusic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bgmediaPlayer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bgmediaPlayer = MediaPlayer.create(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">            bgmediaPlayer.start();</span><br><span class="line">            bgmediaPlayer.setLooping(<span class="keyword">true</span>);</span><br><span class="line">            bgmediaPlayer.setOnCompletionListener(<span class="keyword">new</span> MediaPlayer.OnCompletionListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(MediaPlayer mp)</span> </span>&#123;</span><br><span class="line">                    bgmediaPlayer.start();</span><br><span class="line">                    bgmediaPlayer.setLooping(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bgmediaPlayer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bgmediaPlayer.stop();</span><br><span class="line">            bgmediaPlayer = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TrackFactory.getInstance(getApplicationContext()).stopGather(serviceId, terminalId);</span><br><span class="line">        TrackDemoService.<span class="keyword">this</span>.stopForeground(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="电池白名单"><a href="#电池白名单" class="headerlink" title="电池白名单"></a>电池白名单</h2><p>还有一个问题就是，在8.0以后，存在了电池白名单的问题，如果不申请，后台会被限制活动，这里给出方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断用户是否在电池白名单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.M)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">inWhiteList</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isIgnoring = <span class="keyword">false</span>;</span><br><span class="line">    PowerManager powerManager = (PowerManager) context.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (powerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        isIgnoring = powerManager.isIgnoringBatteryOptimizations(context.getPackageName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isIgnoring;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求电池白名单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Intent <span class="title">doRequestWhiteList</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String packageName = context.getPackageName();</span><br><span class="line">        intent.setAction(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">"package:"</span> + packageName));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>回头再写…  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/1ca89d06.html" data-id="ckag2slm8000lyisu2u1f3cum" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高德/">高德</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
    
      <a href="/archives/abbd6e6.html" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">文档(Personal Used)</div>
      </a>
    
  </nav>


  

  
    
  

</article>



</section>
  <footer class="footer">
  
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 清河阳</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>

<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/ocean_qingheyang.png" alt="清河阳"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>

<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
    </li>
  </ul>
</nav>

<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
<script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>


  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/search.js"></script>


<script src="/js/ocean.js"></script>

</body>
</html>