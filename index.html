<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  
    <meta name="keywords" content="android">
  
  
    <meta name="description" content="三流执行工程师">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    
    清河阳</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="jumbotron">
  <div class="video">
    
      <div class="video-frame">
        <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
      </div>
    
    <div class="video-media">
      <video playsinline autoplay loop muted data-autoplay poster="/images/ocean/ocean.png" x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">清河阳</a></h1>
      <p>也想去山巅看翻云涌雾</p>
      <div><img src="/images/ocean_QHY_WHITE.png" class="brand" alt="清河阳"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>

<div id="landingpage">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>

    
      
        <article id="post-深度集成使用高德地图功能-猎鹰" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/1ca89d06.html">深度集成使用高德地图功能--猎鹰（1）   记录轨迹篇</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/1ca89d06.html" class="article-date">
  <time datetime="2020-01-06T13:29:00.000Z" itemprop="datePublished">2020-01-06</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <p>本文适用对象：已继承了猎鹰功能的朋友及使用期间遇到困难的朋友。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>前段日子公司要求上线一个功能，具有导航，记录轨迹，查看历史行程等功能的一个模块，我用过百度地图，但是公司继承的是高德地图，索性直接用高德，其实我对百度观感也极差，理由就是–作恶多端。<br>功能是要做的，时间也很急，12月上旬左右说的需求，还没有UI图，要求年底前上线，我们大概7个移动端开发人员，全都上了，我主要负责的就是记点，记轨迹，查轨迹的功能，其中遇到了很多很多坑，也算是一种提升吧。  </p>
<hr>
<h1 id="过程-amp-难点"><a href="#过程-amp-难点" class="headerlink" title="过程&amp;难点"></a>过程&amp;难点</h1><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>技术选型预研阶段，与后台考虑过是否自己上传点位，报告位置，一开始是这么选的，后来感觉对于流量还有并发等问题，也是碰巧遇到了高德的猎鹰，研究了下，就直接用人家的接口了，总比花自己的流量要实惠。<br>于是乎我就负责了猎鹰的继承，然后还要帮助同事写一点接口，本文没有关于视图层的东西。</p>
<h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><p>遇到了挺多的难点，其实继承第三方并不困难，困难的就在于，第三方有可能文档不全，这是个问题。<br>我在期间遇到了挺多难题，总结一下吧。<br>记录轨迹的难题有：  </p>
<blockquote>
<ul>
<li>记录点位不全  </li>
<li>内存泄漏的问题  </li>
<li>8.0以上系统后台定位被限制住  </li>
</ul>
</blockquote>
<p>闲话不多说，直接上代码。  </p>
<hr>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'com.amap.api:navi-3dmap:latest.integration'</span></span><br><span class="line">implementation <span class="string">'com.amap.api:search:latest.integration'</span></span><br><span class="line">implementation <span class="string">'org.greenrobot:eventbus:3.1.1'</span></span><br><span class="line">implementation files(<span class="string">'libs/AMapTrack_1.1.0_AMapLocation_4.8.0_20191210.jar'</span>)</span><br></pre></td></tr></table></figure>
<p>继承猎鹰功能必须用jar包形式， <strong>jar包里面顺道包含了定位的sdk，所以不用在二次依赖定位的sdk</strong> ，不然会报错。<br>信息传递使用的是EventBus。</p>
<h2 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h2><p>实体类如下，用于被EventBus传递信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrackInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> terminalId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> trackId;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> canUse;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCanUse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> canUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCanUse</span><span class="params">(<span class="keyword">boolean</span> canUse)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.canUse = canUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTerminalId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> terminalId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTerminalId</span><span class="params">(<span class="keyword">long</span> terminalId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTrackId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> trackId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTrackId</span><span class="params">(<span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.trackId = trackId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="轨迹服务"><a href="#轨迹服务" class="headerlink" title="轨迹服务"></a>轨迹服务</h2><p>官方已经给了启动顺序，我简化了下，根据他的demo也改了下，启动顺序是这样的：  </p>
<blockquote>
<ol>
<li>新建TerminalId,使用QueryTerminalRequest，传入serviceId、terminalName，如果得到terminalId不为0，去往第3步；为0，去第2步。  </li>
<li>因为terminalId=0，所以是一个新的设备，调用AddTerminalRequest，传入serviceId、terminalName，得到terminalId。</li>
<li>根据上一步的回调得到terminalId，调用AddTrackRequest，传入serviceId、terminalId，得到trackId。  </li>
<li>三个id都得到后，可以根据官方api，调用 client.startTrack（）方法，启动轨迹。  </li>
<li>启动轨迹后，在成功的回调里，调用client.startGather（）方法，启动收集点位。  </li>
</ol>
</blockquote>
<p>几步代码如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建路线</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> serviceId</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> terminalName</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> trackId</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTrack</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> serviceId, <span class="keyword">final</span> String terminalName, <span class="keyword">final</span> <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.serviceId = serviceId;</span><br><span class="line">      <span class="keyword">this</span>.trackId = trackId;</span><br><span class="line">      client.queryTerminal(<span class="keyword">new</span> QueryTerminalRequest(serviceId, terminalName), <span class="keyword">new</span> SimpleOnTrackListener() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryTerminalCallback</span><span class="params">(QueryTerminalResponse queryTerminalResponse)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (queryTerminalResponse.isSuccess()) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (queryTerminalResponse.getTid() &lt;= <span class="number">0</span>) &#123;<span class="comment">//新用户去申请terminalId</span></span><br><span class="line">                      addTerminal(serviceId, terminalName, trackId);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">long</span> terminalId = queryTerminalResponse.getTid();<span class="comment">//老用户直接获取terminalId</span></span><br><span class="line">                      <span class="keyword">if</span> (trackId != <span class="number">0</span>) &#123;<span class="comment">//此处为断点续传//如果有trackId，则直接返回成功，去startGather</span></span><br><span class="line">                          <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                              trackDoSthListener.onCreateTrackSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                              onTrackListenerNull();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;<span class="comment">//为0为新的</span></span><br><span class="line">                          createTrack(serviceId, terminalId);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onDoingFailed(queryTerminalResponse.getErrorMsg(), queryTerminalResponse.getErrorCode(), <span class="string">"查询Terminal"</span>);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 新建terminal</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> serviceId</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> terminalName</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> trackId</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTerminal</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> serviceId, String terminalName, <span class="keyword">final</span> <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">      client.addTerminal(<span class="keyword">new</span> AddTerminalRequest(terminalName, serviceId), <span class="keyword">new</span> SimpleOnTrackListener() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTerminalCallback</span><span class="params">(AddTerminalResponse addTerminalResponse)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (addTerminalResponse.isSuccess()) &#123;</span><br><span class="line">                  <span class="keyword">long</span> terminalId = addTerminalResponse.getTid();</span><br><span class="line">                  TrackFactory.<span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">                  <span class="keyword">if</span> (trackId != <span class="number">0</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onCreateTrackSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      createTrack(serviceId, terminalId);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onDoingFailed(addTerminalResponse.getErrorMsg(), addTerminalResponse.getErrorCode(), <span class="string">"新建Terminal"</span>);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 重写方法</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> serviceId</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> terminalId</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createTrack</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> serviceId, <span class="keyword">final</span> <span class="keyword">long</span> terminalId)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">      client.addTrack(<span class="keyword">new</span> AddTrackRequest(serviceId, terminalId), <span class="keyword">new</span> SimpleOnTrackListener() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAddTrackCallback</span><span class="params">(AddTrackResponse addTrackResponse)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (addTrackResponse.isSuccess()) &#123;</span><br><span class="line">                  trackId = addTrackResponse.getTrid();</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onCreateTrackSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      trackDoSthListener.onDoingFailed(addTrackResponse.getErrorMsg(), addTrackResponse.getErrorCode(), <span class="string">"新建Track"</span>);</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      onTrackListenerNull();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>如果收集完毕，轨迹停止顺序为下：  </p>
<blockquote>
<ol>
<li>调用官方api，client.stopGather()，停止收集点位。  </li>
<li>得到停止收集点位成功的回调里，调用client.stopTrack()，停止定位服务。  </li>
</ol>
</blockquote>
<p>值得注意的是，开始的时候是<strong>先启动track，在启动gather。而停止的时候正好是反着的，先停止gather，在停止track，</strong>不要搞反。  </p>
<p>三个Id分别为：serviceId,terminalId,trackId，是核心的东西，需要传给后台服务器，供以后查询使用。<br>猎鹰生命周期如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动猎鹰生命周期回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">newListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        listener = <span class="keyword">new</span> OnTrackLifecycleListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindServiceCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartGatherCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.START_GATHER_SUCEE ||</span><br><span class="line">                        i == ErrorCode.TrackListen.START_GATHER_ALREADY_STARTED) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onStartSuccess(serviceId, terminalId, trackId);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, <span class="number">0</span>, <span class="string">"定位开始收集失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartTrackCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.START_TRACK_SUCEE ||</span><br><span class="line">                        i == ErrorCode.TrackListen.START_TRACK_SUCEE_NO_NETWORK ||</span><br><span class="line">                        i == ErrorCode.TrackListen.START_TRACK_ALREADY_STARTED) &#123;</span><br><span class="line">                    <span class="comment">// 服务启动成功，继续开启收集上报</span></span><br><span class="line">                    client.startGather(<span class="keyword">this</span>);</span><br><span class="line">                    <span class="comment">//ToastUtil.getInstance()._short(context, "开始路程成功");</span></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, <span class="number">0</span>, <span class="string">"Track服务启动失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopGatherCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.STOP_GATHER_SUCCE) &#123;</span><br><span class="line">                    TrackParam tp = <span class="keyword">new</span> TrackParam(serviceId, terminalId);</span><br><span class="line">                    client.stopTrack(tp, listener);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, i, <span class="string">"定位停止采集失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopTrackCallback</span><span class="params">(<span class="keyword">int</span> i, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (i == ErrorCode.TrackListen.STOP_TRACK_SUCCE) &#123;</span><br><span class="line">                    <span class="comment">// 成功停止</span></span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onStopSuccess();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (trackDoSthListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        trackDoSthListener.onDoingFailed(s, i, <span class="string">"路程停止失败"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        onTrackListenerNull();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面大概就是猎鹰功能的核心代码，很多都没写全，本想着开一篇就够了，但是感觉篇幅太长，就算了。  </p>
<h2 id="前台服务"><a href="#前台服务" class="headerlink" title="前台服务"></a>前台服务</h2><p>猎鹰功能本身是自己带着service的，但是如果一直处在后台状态，会被杀死，尤其是Android 8.0以后，限制住了很多权限，其中就有后台定位功能。<br>猎鹰推荐8.0系统启动一个 ForcegroundService，新出的前台进程，也可以给他们的api传一个notification，让他们自己启动前台进程，但是有一个问题，就是他们的接口已经过时了，不能用了，于是我研究了下，就自己写了一个前台Service来确保猎鹰可以正常取点。<br>我在其中做了个media Player来确保尽可能不被后台杀死。<br><strong>在单例里面用四大组件的上下文一定要特别注意，最好传getApplicationContext()，因为Application的上下文是能贯穿整个app的</strong>，我一开始因为失误，再单例里面传了Service的上下文，导致service一直无法被回收，导致内存泄漏。<br>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ************************************************************</span></span><br><span class="line"><span class="comment"> * 文件：CarManageService.java  模块：app  项目：oemp-android</span></span><br><span class="line"><span class="comment"> * 当前修改时间：2019年12月25日 09:57:10</span></span><br><span class="line"><span class="comment"> * 上次修改时间：2019年12月25日 09:57:10</span></span><br><span class="line"><span class="comment"> * 作者：QingHeyang</span></span><br><span class="line"><span class="comment"> * QingHeyang版权所有</span></span><br><span class="line"><span class="comment"> * ************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.qhy.trackdemo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Notification;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationChannel;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationManager;</span><br><span class="line"><span class="keyword">import</span> android.app.PendingIntent;</span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.BitmapDrawable;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaPlayer;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.qhy.trackdemo.MainActivity;</span><br><span class="line"><span class="keyword">import</span> com.qhy.trackdemo.R;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.EventBus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrackDemoService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHANNEL_ID_SERVICE_RUNNING = <span class="string">"CHANNEL_ID_SERVICE_RUNNING"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> serviceId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> terminalId, trackId;</span><br><span class="line">    <span class="keyword">private</span> String terminalName;</span><br><span class="line">    <span class="keyword">private</span> Notification notification;</span><br><span class="line">    <span class="keyword">private</span> MediaPlayer bgmediaPlayer;</span><br><span class="line">    <span class="keyword">private</span> Intent intent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Notification notification = registerNotification();</span><br><span class="line">        <span class="keyword">this</span>.notification = notification;</span><br><span class="line">       <span class="comment">// BaseApplication.getRefWatcher().watch(this);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.intent = intent;</span><br><span class="line">            startGather(intent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> START_REDELIVER_INTENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册用于8.0以后的手机</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Notification <span class="title">registerNotification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Notification.Builder builder;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">            NotificationManager nm = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line">            NotificationChannel channel = <span class="keyword">new</span> NotificationChannel(CHANNEL_ID_SERVICE_RUNNING</span><br><span class="line">                    , <span class="string">"猎鹰服务"</span></span><br><span class="line">                    , NotificationManager.IMPORTANCE_LOW);</span><br><span class="line">            nm.createNotificationChannel(channel);</span><br><span class="line">            builder = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>, CHANNEL_ID_SERVICE_RUNNING);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Intent nfIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class);<span class="comment">//此处的Activity为前台进程的Notification点击回调页面</span></span><br><span class="line">        nfIntent.putExtra(<span class="string">"fromService"</span>, <span class="keyword">true</span>);</span><br><span class="line">        Bitmap bitmap = ((BitmapDrawable) getResources().getDrawable(R.mipmap.ic_launcher)).getBitmap();<span class="comment">//此处icon需要根据自己需求来</span></span><br><span class="line">        builder.setContentIntent(PendingIntent.getActivity(<span class="keyword">this</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                nfIntent, PendingIntent.FLAG_UPDATE_CURRENT))</span><br><span class="line">                .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">                .setLargeIcon(bitmap)</span><br><span class="line">                .setContentTitle(<span class="string">"您的有未完成的行程进行中..."</span>)</span><br><span class="line">                .setContentText(<span class="string">"点击回到行程"</span>);</span><br><span class="line">        Notification notification = builder.build();</span><br><span class="line">        <span class="keyword">return</span> notification;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始收集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> intent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startGather</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        terminalName = intent.getStringExtra(<span class="string">"terminalName"</span>);</span><br><span class="line">        trackId = intent.getLongExtra(<span class="string">"trackId"</span>, <span class="number">0</span>);</span><br><span class="line">        serviceId = intent.getLongExtra(<span class="string">"serviceId"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*Notification notification =  registerNotification();</span></span><br><span class="line"><span class="comment">        startForeground((int) System.currentTimeMillis(),notification);*/</span></span><br><span class="line"></span><br><span class="line">        TrackFactory.getInstance(getApplicationContext()).setOnTrackDoSthListener(<span class="keyword">new</span> TrackFactory.OnTrackDoSthListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTrackSuccess</span><span class="params">(<span class="keyword">long</span> serviceId, <span class="keyword">long</span> terminalId, <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">                TrackDemoService.<span class="keyword">this</span>.terminalId = terminalId;</span><br><span class="line">                TrackDemoService.<span class="keyword">this</span>.trackId = trackId;</span><br><span class="line">                TrackFactory.getInstance(TrackDemoService.<span class="keyword">this</span>.getApplicationContext()).startGather(serviceId, terminalId, trackId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartSuccess</span><span class="params">(<span class="keyword">long</span> serviceId, <span class="keyword">long</span> terminalId, <span class="keyword">long</span> trackId)</span> </span>&#123;</span><br><span class="line">                TrackInfo info = <span class="keyword">new</span> TrackInfo();</span><br><span class="line">                info.setTrackId(trackId);</span><br><span class="line">                info.setTerminalId(terminalId);</span><br><span class="line">                info.setCanUse(<span class="keyword">true</span>);</span><br><span class="line">                EventBus.getDefault().post(info);</span><br><span class="line">                startForeground((<span class="keyword">int</span>) System.currentTimeMillis(), notification);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDoingFailed</span><span class="params">(String msg, <span class="keyword">long</span> code, String from)</span> </span>&#123;</span><br><span class="line">                TrackInfo info = <span class="keyword">new</span> TrackInfo();</span><br><span class="line">                info.setMessage(msg + <span class="string">"\n"</span> + from);</span><br><span class="line">                info.setCanUse(<span class="keyword">false</span>);</span><br><span class="line">                EventBus.getDefault().post(info);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        TrackFactory.getInstance(getApplicationContext()).createTrack(serviceId, terminalName, trackId);</span><br><span class="line">        playMusic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此处播放无声音乐，用来不被系统杀死</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">playMusic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bgmediaPlayer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bgmediaPlayer = MediaPlayer.create(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">            bgmediaPlayer.start();</span><br><span class="line">            bgmediaPlayer.setLooping(<span class="keyword">true</span>);</span><br><span class="line">            bgmediaPlayer.setOnCompletionListener(<span class="keyword">new</span> MediaPlayer.OnCompletionListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(MediaPlayer mp)</span> </span>&#123;</span><br><span class="line">                    bgmediaPlayer.start();</span><br><span class="line">                    bgmediaPlayer.setLooping(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bgmediaPlayer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bgmediaPlayer.stop();</span><br><span class="line">            bgmediaPlayer = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TrackFactory.getInstance(getApplicationContext()).stopGather(serviceId, terminalId);</span><br><span class="line">        TrackDemoService.<span class="keyword">this</span>.stopForeground(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="电池白名单"><a href="#电池白名单" class="headerlink" title="电池白名单"></a>电池白名单</h2><p>还有一个问题就是，在8.0以后，存在了电池白名单的问题，如果不申请，后台会被限制活动，这里给出方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断用户是否在电池白名单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.M)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">inWhiteList</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isIgnoring = <span class="keyword">false</span>;</span><br><span class="line">    PowerManager powerManager = (PowerManager) context.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (powerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        isIgnoring = powerManager.isIgnoringBatteryOptimizations(context.getPackageName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isIgnoring;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求电池白名单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Intent <span class="title">doRequestWhiteList</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String packageName = context.getPackageName();</span><br><span class="line">        intent.setAction(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">"package:"</span> + packageName));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>回头再写…  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/1ca89d06.html" data-id="ckag2slm8000lyisu2u1f3cum" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高德/">高德</a></li></ul>

    </footer>

  </div>

  

  

</article>



      
        <article id="post-文档" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/abbd6e6.html">文档(Personal Used)</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/abbd6e6.html" class="article-date">
  <time datetime="2019-12-21T08:33:44.000Z" itemprop="datePublished">2019-12-21</time>
</a>
        
      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <h2 id="日历页："><a href="#日历页：" class="headerlink" title="日历页："></a>日历页：</h2><p><a href="http://xxxx.xxx.xx:/WeekStory/queryMonth.do?from=1&amp;date=2019-12-01" target="_blank" rel="noopener">http://xxxx.xxx.xx:/WeekStory/queryMonth.do?from=1&amp;date=2019-12-01</a>  (Get)<br>返回结果：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"monthInfo"</span>:[</span><br><span class="line">		<span class="number">2019</span><span class="number">-12</span><span class="number">-21</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="点击日期检查是否有文件"><a href="#点击日期检查是否有文件" class="headerlink" title="点击日期检查是否有文件"></a>点击日期检查是否有文件</h2><p><a href="http://xxxx.xxx.xx:/WeekStory/doSomethingCheck.do?from=1&amp;date=2019-12-21" target="_blank" rel="noopener">http://xxxx.xxx.xx:/WeekStory/doSomethingCheck.do?from=1&amp;date=2019-12-21</a>  (Get)<br>返回结果：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"file exist"</span>,</span><br><span class="line">    <span class="attr">"code"</span>:<span class="number">200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="点击创建文件"><a href="#点击创建文件" class="headerlink" title="点击创建文件"></a>点击创建文件</h2><p><a href="http://xxxx.xxx.xx:/WeekStory/doSomethingCreate.do?from=1&amp;date=2019-12-21" target="_blank" rel="noopener">http://xxxx.xxx.xx:/WeekStory/doSomethingCreate.do?from=1&amp;date=2019-12-21</a>  (Get)<br>返回结果：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"msg"</span>:<span class="string">"1-20191216-20191222.xls"</span>,<span class="attr">"code"</span>:<span class="number">200</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="进入页面提交所写内容"><a href="#进入页面提交所写内容" class="headerlink" title="进入页面提交所写内容"></a>进入页面提交所写内容</h2><p><a href="http://xxxx.xxx.xx:/WeekStory/doSomethingSubmit.do" target="_blank" rel="noopener">http://xxxx.xxx.xx:/WeekStory/doSomethingSubmit.do</a>    (post)<br>参数：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"workStr1"</span>:<span class="string">"测试工作1"</span>,</span><br><span class="line">    <span class="attr">"workStr2"</span>:<span class="string">"测试工作2"</span>,</span><br><span class="line">    <span class="attr">"workStr3"</span>:<span class="string">"测试工作3"</span>,</span><br><span class="line">    <span class="attr">"lifeStr1"</span>:<span class="string">"测试生活1"</span>,</span><br><span class="line">    <span class="attr">"lifeStr2"</span>:<span class="string">"测试生活2"</span>,</span><br><span class="line">    <span class="attr">"lifeStr3"</span>:<span class="string">"测试生活3"</span>,</span><br><span class="line">    <span class="attr">"bzStr"</span>:<span class="string">"暂无备注"</span>,</span><br><span class="line">    <span class="attr">"sleepTime"</span>:<span class="string">"07:00"</span>,</span><br><span class="line">    <span class="attr">"weakTime"</span>:<span class="string">"23:00"</span>,</span><br><span class="line">    <span class="attr">"curDate"</span>:<span class="string">"2019-12-21"</span>,</span><br><span class="line">    <span class="attr">"user"</span>:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="查询已有的某天"><a href="#查询已有的某天" class="headerlink" title="查询已有的某天"></a>查询已有的某天</h2><p><a href="http://xxxx.xxx.xx:/WeekStory/doSomethingQueryDay.do?from=1&amp;date=2019-12-21" target="_blank" rel="noopener">http://xxxx.xxx.xx:/WeekStory/doSomethingQueryDay.do?from=1&amp;date=2019-12-21</a>  (Get)<br>返回结果：  </p>
<pre><code class="json">{
    <span class="attr">"workStr1"</span>: <span class="string">"测试工作1"</span>,
    <span class="attr">"workStr2"</span>: <span class="string">"测试工作2"</span>,
    <span class="attr">"workStr3"</span>: <span class="string">"测试工作3"</span>,
    <span class="attr">"lifeStr1"</span>: <span class="string">"测试生活1"</span>,
    <span class="attr">"lifeStr2"</span>: <span class="string">"测试生活2"</span>,
    <span class="attr">"lifeStr3"</span>: <span class="string">"测试生活3"</span>,
    <span class="attr">"bzStr"</span>: <span class="string">"暂无备注"</span>,
    <span class="attr">"sleepTime"</span>: <span class="string">"07:00"</span>,
    <span class="attr">"weakTime"</span>: <span class="string">"23:00"</span>,
    <span class="attr">"dayOfWeek"</span>: <span class="number">0</span>,
    <span class="attr">"user"</span>: <span class="number">0</span>
}

</code></pre>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>这些接口均为个人项目接口，待前端来校验。<br>说明写于：2020-01-06  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/abbd6e6.html" data-id="ckag2slm3000hyisuz0ss5cie" class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  

</article>



      
        <article id="post-android深入之路-AOP切面编程" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/db153085.html">Android深入之路:AOP切面编程</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/db153085.html" class="article-date">
  <time datetime="2019-05-13T09:49:41.000Z" itemprop="datePublished">2019-05-13</time>
</a>
        
      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>这次研究aop其实没有什么背景的，就是觉得到新公司，做项目，应该带有一些跟以前项目不一样的技术，二来我也是喜欢各种技术的，这回没有带着需求，就直接来做一个demo了。</p>
<hr>
<h1 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h1><p>想了很久还是没有着手，老实说aop的东西我已经弄好了，感觉应用场景特别大，想想怎么配合吧。<br>更新于：2020-01-06</p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/db153085.html" data-id="ckag2sllh000byisumjdr2v0x" class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  

</article>



      
        <article id="post-记一次HLS视频加解密方案的过程（2）" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/88e27efc.html">记一次HLS视频加解密方案的过程（2）</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/88e27efc.html" class="article-date">
  <time datetime="2019-05-06T09:16:00.000Z" itemprop="datePublished">2019-05-06</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>上个月花了点时间做了下视频流媒体的方案。<br>传送门:<a href="https://blog.qingheyang.studio/archives/a137cd06.html">记一次HLS视频加解密方案的过程（1）</a><br>最后实现的效果是用自己的播放器播放了hls视频流，且视频都加过密了，形成一整套基础的方案。<br>这次呢，出了个方案的升级版，因为使用场景的限制，导致公司必须要对hls视频流进行二次加密。  </p>
<hr>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>我在网上查了很久，google关于key加密的文章已经读到20页+了。<br>最后只查到了jwplayer这个国外的公司有一种方案，就是对m3u8这个索引文件的AES-128这个字段的获取上面加token，让key文件获取的不是那么容易，但是具体实现还是没有给出来，给出来的android demo也是各种错误，跑不起来。<br>我想各个大厂对自己的hls视频流一定有自己的二次加密的方式，因为我在试用保利威视的sdk的时候，下载了人家的完整的加密视频，但是我没有办法用自己的播放器播出来，所以，肯定做了二次加密的文章。</p>
<hr>
<h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><p>跟上回一样先说一下方案，简单的说，就是对key文件的获取上面进行操作。<br>首先要明白几个道理：  </p>
<blockquote>
<ol>
<li>就是播放器读的是m3u8文件，所以操作m3u8文件，就是操作了播放器。  </li>
<li>播放器读m3u8内部信息，最后所发出的请求，全部是GET请求，不争的事实。</li>
</ol>
</blockquote>
<p>明白这两点，思路就出来了：  </p>
<blockquote>
<ol>
<li>在服务器中保存的m3u8文件要进行错误混淆。  </li>
<li>在移动端开启http服务器。  </li>
<li>下载服务器m3u8文件，并进行改写。  </li>
<li>播放本地服务器中m3u8文件，至播放完毕。  </li>
<li>删除改写过后的m3u8文件，并关闭http服务器。  </li>
</ol>
</blockquote>
<p>步骤大致就是上述那样了，具体说明一下。  </p>
<hr>
<h1 id="m3u8修改混淆"><a href="#m3u8修改混淆" class="headerlink" title="m3u8修改混淆"></a>m3u8修改混淆</h1><p>看一个普通的m3u8文件的构造:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:20</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI=&quot;http://test.com/enc.key&quot;,IV=0xc25a7ccb63553b6be3f72a89b50d4dd0</span><br><span class="line">#EXTINF:15.840000,</span><br><span class="line">Y29_050102_VD_04_0_ts</span><br><span class="line">#EXTINF:16.720000,</span><br><span class="line">Y29_050102_VD_04_1_ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure></p>
<p>加入错误混淆后，去掉URI节点的key，并且保存在服务器中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:20</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI=&quot;&quot;,IV=0xc25a7ccb63553b6be3f72a89b50d4dd0</span><br><span class="line">#EXTINF:15.840000,</span><br><span class="line">Y29_050102_VD_04_0_ts</span><br><span class="line">#EXTINF:16.720000,</span><br><span class="line">Y29_050102_VD_04_1_ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure></p>
<p>这样，在m3u8中就不存在被别人获取到key的问题了。  </p>
<hr>
<h1 id="Android开启Http服务器"><a href="#Android开启Http服务器" class="headerlink" title="Android开启Http服务器"></a>Android开启Http服务器</h1><p>我用的是nanoHttp，比较好用。<br>首先写个类集成NanoHTTPD，作为服务调度类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo.video;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目名称:sohero.com.testhlsvideo.video</span></span><br><span class="line"><span class="comment"> * 类创建者:QHY.</span></span><br><span class="line"><span class="comment"> * 时间:2019/4/29</span></span><br><span class="line"><span class="comment"> * 类说明:开启httpServer，获取文件类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HlsHttpServer</span> <span class="keyword">extends</span> <span class="title">NanoHTTPD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HlsHttpServer</span><span class="params">(String hostname, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(hostname, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HlsHttpServer</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">serve</span><span class="params">(IHTTPSession session)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.parseBody(<span class="keyword">new</span> HashMap&lt;String, String&gt;());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ResponseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MyApplication app = <span class="keyword">new</span> MyApplication();</span><br><span class="line">        String path = Environment.getExternalStorageDirectory().getPath() + <span class="string">"/HlsTemp/"</span>;<span class="comment">//获取文件夹地址</span></span><br><span class="line">        Log.i(TAG, <span class="string">"uri: "</span> + path);</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(path + session.getUri());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.newFixedLengthResponse(Status.OK, <span class="string">"application/octet-stream"</span>, fis, fis.available());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newFixedLengthResponse(<span class="string">"404 error,no such file"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建一个Service，开启HttpServer:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Not yet implemented"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        HlsHttpServer myServer = <span class="keyword">new</span> HlsHttpServer(<span class="number">8080</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 开启HTTP服务</span></span><br><span class="line">            myServer.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h1 id="下载m3u8文件"><a href="#下载m3u8文件" class="headerlink" title="下载m3u8文件"></a>下载m3u8文件</h1><p>下载m3u8文件,并进行改写，代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目名称:sohero.com.testhlsvideo</span></span><br><span class="line"><span class="comment"> * 类创建者:QHY.</span></span><br><span class="line"><span class="comment"> * 时间:2019/4/29</span></span><br><span class="line"><span class="comment"> * 类说明:下载m3u8文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpFileUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">downLoadFile</span><span class="params">(String httpUrl, String name)</span> </span>&#123;</span><br><span class="line">        String HLS_PATH = Environment.getExternalStorageDirectory().getPath() + <span class="string">"/HlsTemp/"</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(httpUrl);</span><br><span class="line">            HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">            conn.setReadTimeout(<span class="number">30000</span>);</span><br><span class="line">            conn.setConnectTimeout(<span class="number">3000</span>);</span><br><span class="line">            conn.connect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//读到流中</span></span><br><span class="line">            InputStream is = conn.getInputStream();</span><br><span class="line">            <span class="keyword">byte</span> buf[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">            ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">while</span> ((len = is.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//新建文件</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(HLS_PATH);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                file.mkdir();</span><br><span class="line">            &#125;</span><br><span class="line">            File m3u8file = <span class="keyword">new</span> File(HLS_PATH, name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//写到流中</span></span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(m3u8file);</span><br><span class="line">            fos.write(bos.toByteArray());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//关闭流</span></span><br><span class="line">            fos.close();</span><br><span class="line">            bos.close();</span><br><span class="line">            is.close();</span><br><span class="line">            conn.disconnect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> writeFile(HLS_PATH + name);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">writeFile</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(path);</span><br><span class="line">        FileReader reader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> FileReader(file);</span><br><span class="line"></span><br><span class="line">            BufferedReader bReader = <span class="keyword">new</span> BufferedReader(reader);</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            String s = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">int</span> line = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((s = bReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (line &gt;= <span class="number">7</span> &amp;&amp; line % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                    sb.append(ContentValues.NET_PATH  + s + <span class="string">"\n"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(s + <span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                line += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String str = sb.toString();</span><br><span class="line">            Log.v(<span class="string">"Tag"</span>, str);</span><br><span class="line">            String[] strs = str.split(<span class="string">"\""</span>);</span><br><span class="line">            str = strs[<span class="number">0</span>] + <span class="string">"\""</span> + ContentValues.KEY_PATH + <span class="string">"\""</span> + strs[<span class="number">2</span>];</span><br><span class="line">            FileWriter writer = <span class="keyword">new</span> FileWriter(file);</span><br><span class="line">            writer.write(str);</span><br><span class="line">            writer.flush();</span><br><span class="line">            writer.close();</span><br><span class="line">            bReader.close();</span><br><span class="line">            reader.close();</span><br><span class="line">            <span class="comment">//handler.sendEmptyMessage(0x002);</span></span><br><span class="line">            Log.v(<span class="string">"Tag"</span>, str);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h1 id="播放视频"><a href="#播放视频" class="headerlink" title="播放视频"></a>播放视频</h1><p>本来想随便写写activity，后来想想，还是乖乖的用mvp吧。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><ol>
<li>IMainContract:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.reactivex.Observable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目名称:sohero.com.testhlsvideo</span></span><br><span class="line"><span class="comment"> * 类创建者:QHY.</span></span><br><span class="line"><span class="comment"> * 时间:2019/5/7</span></span><br><span class="line"><span class="comment"> * 类说明:Main页面接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMainContract</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">IMainPersenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取权限</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getPermission</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 下载文件，自己封装的RxJava</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getHlsFile</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 刷新sb,用了RxLifeCycle,防止内存泄露,感觉快用了Rx全家桶了</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">refreshProgress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 删除文件</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">deleteHlsFile</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">IMainView</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取权限成功</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getPermissionSuccess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取权限失败</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getPermissionFailed</span><span class="params">(String msg)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 下载文件成功</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getHlsFileSuccess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 下载文件失败</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> msg 错误信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getHlsFileFailed</span><span class="params">(String msg)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 刷新seekBar的progress，一秒一次</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">refreshProgress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 播放完成，删除文件成功</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">deleteHlsFileSuccess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 播放完成，删除文件失败</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">deleteHlsFileFailed</span><span class="params">(String msg)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span>  <span class="title">IMainModel</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 下载文件,耗时操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function">Observable&lt;Boolean&gt; <span class="title">getHlsFile</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 删除文件，耗时操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function">Observable&lt;Boolean&gt; <span class="title">deleteHlsFile</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现类"><a href="#实现类" class="headerlink" title="实现类"></a>实现类</h2><ol>
<li>Activity:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>...;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sohero.com.testhlsvideo.video.media.UsIjkVideoView;</span><br><span class="line"><span class="keyword">import</span> tv.danmaku.ijk.media.player.IMediaPlayer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">SeekBar</span>.<span class="title">OnSeekBarChangeListener</span>, <span class="title">IMainContract</span>.<span class="title">IMainView</span>, <span class="title">IMediaPlayer</span>.<span class="title">OnPreparedListener</span>, <span class="title">IMediaPlayer</span>.<span class="title">OnCompletionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    UsIjkVideoView ijkVideoView;<span class="comment">//IjkPlayer,我封装了一层，用法一样</span></span><br><span class="line">    SeekBar sb;<span class="comment">//seekBar</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IMainContract.IMainPersenter persenter; <span class="comment">//persenter</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        initView();</span><br><span class="line">        persenter = <span class="keyword">new</span> MainPersenter(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">        persenter.getPermission();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ijkVideoView =  findViewById(R.id.ijk_vv);</span><br><span class="line">        sb =  findViewById(R.id.main_sb);</span><br><span class="line">        sb.setOnSeekBarChangeListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getPermissionSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        startService(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, MyServer.class));</span><br><span class="line">        <span class="comment">//开始下载m3u8文件</span></span><br><span class="line">        persenter.getHlsFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getPermissionFailed</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(MainActivity.<span class="keyword">this</span>, msg, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getHlsFileSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"下载完成，播放视频"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        startPlayVideo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getHlsFileFailed</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, msg, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshProgress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sb.setProgress(ijkVideoView.getCurrentPosition());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteHlsFileSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"播放完成，缓存文件删除成功"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        sb.setMax(<span class="number">0</span>);</span><br><span class="line">        sb.setProgress(<span class="number">0</span>);</span><br><span class="line">        ijkVideoView.release(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteHlsFileFailed</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, msg, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始播放视频,开始刷新进度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startPlayVideo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ijkVideoView.setVideoPath(ContentValues.LOCAL_PATH + ContentValues.FILE_NAME);</span><br><span class="line">        ijkVideoView.setOnPreparedListener(<span class="keyword">this</span>);</span><br><span class="line">        ijkVideoView.setOnCompletionListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(IMediaPlayer iMediaPlayer)</span> </span>&#123;</span><br><span class="line">        ijkVideoView.start();</span><br><span class="line">        sb.setMax((<span class="keyword">int</span>) iMediaPlayer.getDuration());</span><br><span class="line">        persenter.refreshProgress();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(IMediaPlayer iMediaPlayer)</span> </span>&#123;</span><br><span class="line">        persenter.deleteHlsFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * seekBar相关</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seekBar</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> progress</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fromUser</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProgressChanged</span><span class="params">(SeekBar seekBar, <span class="keyword">int</span> progress, <span class="keyword">boolean</span> fromUser)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartTrackingTouch</span><span class="params">(SeekBar seekBar)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopTrackingTouch</span><span class="params">(SeekBar seekBar)</span> </span>&#123;</span><br><span class="line">        ijkVideoView.seekTo(seekBar.getProgress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Persenter:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目名称:sohero.com.testhlsvideo</span></span><br><span class="line"><span class="comment"> * 类创建者:QHY.</span></span><br><span class="line"><span class="comment"> * 时间:2019/5/7</span></span><br><span class="line"><span class="comment"> * 类说明:Persenter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainPersenter</span> <span class="keyword">implements</span> <span class="title">IMainContract</span>.<span class="title">IMainPersenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IMainContract.IMainView view;</span><br><span class="line">    <span class="keyword">private</span> IMainContract.IMainModel model;</span><br><span class="line">    <span class="keyword">private</span> MainActivity activity;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainPersenter</span><span class="params">(IMainContract.IMainView view, MainActivity context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.view = view;</span><br><span class="line">        <span class="keyword">this</span>.activity = context;</span><br><span class="line">        model = <span class="keyword">new</span> MainModel(activity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getPermission</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        USUtils.getInstance().usePermission()</span><br><span class="line">                .setContext(activity)</span><br><span class="line">                .setPermission(UsConst.Permission.WRITE_EXTERNAL_STORAGE)</span><br><span class="line">                .getPermission(<span class="keyword">new</span> UsPermission.PermissionCallBack() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        view.getPermissionSuccess();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        view.getPermissionFailed(<span class="string">"please get permission for app"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getHlsFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        model.getHlsFile()</span><br><span class="line">                .subscribe(<span class="keyword">new</span> UsRxJava&lt;Boolean&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_onNext</span><span class="params">(Boolean s)</span> </span>&#123;</span><br><span class="line">                        view.getHlsFileSuccess();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_onError</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">                        view.getHlsFileFailed(msg);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_onFinish</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshProgress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS).compose(UsRxJava.&lt;Long&gt;thread_main()).subscribe(<span class="keyword">new</span> Consumer&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Long aLong)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                view.refreshProgress();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteHlsFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        model.deleteHlsFile()</span><br><span class="line">                .subscribe(<span class="keyword">new</span> UsRxJava&lt;Boolean&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_onNext</span><span class="params">(Boolean aBoolean)</span> </span>&#123;</span><br><span class="line">                        view.deleteHlsFileSuccess();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_onError</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">                        view.deleteHlsFileFailed(msg);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_onFinish</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>model:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.reactivex.Observable;</span><br><span class="line"><span class="keyword">import</span> io.reactivex.ObservableEmitter;</span><br><span class="line"><span class="keyword">import</span> qhy.com.unlimitedswordutils.USUtils;</span><br><span class="line"><span class="keyword">import</span> qhy.com.unlimitedswordutils.UsObservable;</span><br><span class="line"><span class="keyword">import</span> qhy.com.unlimitedswordutils.UsRxJava;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目名称:sohero.com.testhlsvideo</span></span><br><span class="line"><span class="comment"> * 类创建者:QHY.</span></span><br><span class="line"><span class="comment"> * 时间:2019/5/7</span></span><br><span class="line"><span class="comment"> * 类说明:model</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainModel</span> <span class="keyword">implements</span> <span class="title">IMainContract</span>.<span class="title">IMainModel</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MainActivity activity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainModel</span><span class="params">(MainActivity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.activity = activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Boolean&gt; <span class="title">getHlsFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  USUtils.getInstance().useRx().create(<span class="keyword">new</span> UsObservable.UsSubcribe&lt;Boolean&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomeThings</span><span class="params">(ObservableEmitter&lt;Boolean&gt; e)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">boolean</span> result = HttpFileUtils.downLoadFile(activity, ContentValues.NET_PATH, ContentValues.FILE_NAME);</span><br><span class="line">                <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                    e.onNext(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    e.onError(<span class="keyword">new</span> Throwable(<span class="string">"download failed"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).compose(UsRxJava.&lt;Boolean&gt;io_main());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Boolean&gt; <span class="title">deleteHlsFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> USUtils.getInstance().useRx().create(<span class="keyword">new</span> UsObservable.UsSubcribe&lt;Boolean&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomeThings</span><span class="params">(ObservableEmitter&lt;Boolean&gt; e)</span> </span>&#123;</span><br><span class="line">                File file = <span class="keyword">new</span> File(Environment.getExternalStorageDirectory() + <span class="string">"/HlsTemp/"</span> + ContentValues.FILE_NAME);</span><br><span class="line">                <span class="keyword">if</span> (file.exists() &amp;&amp; file.isFile()) &#123;</span><br><span class="line">                    file.delete();</span><br><span class="line">                    e.onNext(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    e.onError(<span class="keyword">new</span> Exception(<span class="string">"no such file"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).compose(UsRxJava.&lt;Boolean&gt;thread_main());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>地址  </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目名称:sohero.com.testhlsvideo</span></span><br><span class="line"><span class="comment"> * 类创建者:QHY.</span></span><br><span class="line"><span class="comment"> * 时间:2019/5/7</span></span><br><span class="line"><span class="comment"> * 类说明:地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentValues</span> </span>&#123;</span><br><span class="line">    <span class="comment">//本地视频地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCAL_PATH = <span class="string">"http://127.0.0.1:8080/"</span>;</span><br><span class="line">    <span class="comment">//网络视频地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NET_PATH = <span class="string">"http://www.qingheyang.studio:8000/program/testHlsVideo/"</span>;</span><br><span class="line">    <span class="comment">//key地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PATH = <span class="string">"http://www.qingheyang.studio:8000/program/testHlsVideo/key/enc.qhy"</span>;</span><br><span class="line">    <span class="comment">//保存的文件名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_NAME = <span class="string">"butter_fly_list.m3u8"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>视图我就不上了，这个项目回头我给上传一下github，节省篇幅，我把import的包全给删掉了。<br>总体思路就是上述那样，在服务器上的m3u8文件是个假文件，就算是抓包也是抓到的假文件，到移动端，改写m3u8，填入正确信息，在URI上面填入正确的key路径信息，做到无法盗取全链。<br>因为我不会写后台，所以对接口也比较蒙，其实完全可以先获取下token，然后改写URI，服务端要验证token后才返回文件，这样会更好一些。  </p>
<hr>
<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>应该是以后不会更新这两篇文章了，毕竟要换工作了，不知道会不会还是继续深入研究，如果有什么不懂的话，可以下面问我，也可以戳我邮箱 <a href="mailto:775495797@qq.com" target="_blank" rel="noopener">775495797@qq.com</a> ，匆匆忙忙的写的这篇文章，很多地方还没校对，先这样。  </p>
<p>—————–更新—————–<br>花了点时间校对，改了下demo，顺带把项目上传到github中，在给几个传送门：  </p>
<blockquote>
<p>demo资源（有教程，可也以看我以前的那篇文章）：<a href="http://www.qingheyang.studio:8000/program/testHlsVideo/AllFile.zip" target="_blank" rel="noopener">点这里</a><br>项目github（欢迎给star）：<a href="https://github.com/QingHeYang/TestHlsVideo" target="_blank" rel="noopener">点这里</a><br>项目zip下载（as:3.4,gradle:4.8.1,gradle-tools:3.2.1）：<a href="http://www.qingheyang.studio:8000/program/testHlsVideo/TestHlsVideo.zip" target="_blank" rel="noopener">点这里</a>  </p>
</blockquote>
<p>以上</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/88e27efc.html" data-id="ckag2slmi000qyisudsquindi" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HLS/">HLS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ijkPlayer/">ijkPlayer</a></li></ul>

    </footer>

  </div>

  

  

</article>



      
        <article id="post-记一次Hls视频加解密的方案的过程" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/a137cd06.html">记一次HLS视频加解密方案的过程（1）</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/a137cd06.html" class="article-date">
  <time datetime="2019-04-01T00:46:00.000Z" itemprop="datePublished">2019-04-01</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <h1 id="前言-amp-背景"><a href="#前言-amp-背景" class="headerlink" title="前言&amp;背景"></a>前言&amp;背景</h1><p>最近脑壳很疼，事情是这样的。<br>很久之前，公司的一个app产品要播放视频教学文件，我跟一个哥们一合计，本来想的是弄一个VideoView，封装一个MediaController，简单实用。<br>后来等原型出来后，我们技术准备也完成了，领导突然说，视频是flv的，当时就傻眼了，换播放器，编译ijk，编译ffmpeg，各种折腾，算是折腾好了，项目也上线了。<br>再后来，最近，领导说要视频加密，又傻眼了，没弄过啊，我一移动端不会啊，好在当初折腾过NDK，也折腾过ffmpeg，就开始了视频加密。  </p>
<hr>
<h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><p>现在公司移动端就剩我一个人了，ios也跑了。<br>后台的兄弟天天忙别的，PC端的视频加密，是加密的flv文件，买的别的公司的技术服务，我大致看了下，应该是自己写了个编码器，加密视频进行编码，然后播放的时候用的ffplay，自己套一个自己写的解码器，我感觉我技术还是达不到写编码器解码器这个水平的，就转战研究前人走过的路。<br>我折腾出了两种方案，大致是：  </p>
<blockquote>
<ul>
<li>对mp4静态文件加密。  </li>
<li>对mp4视频转为hls视频流。 </li>
</ul>
</blockquote>
<h1 id="mp4静态文件加密"><a href="#mp4静态文件加密" class="headerlink" title="mp4静态文件加密"></a>mp4静态文件加密</h1><p>这个方案很简单，原理就是先把mp4文件通过流读取，然后再保存，过程插入加密的字符就ok了。  </p>
<blockquote>
<ul>
<li>优点：操作起来简单，不用耗工时。</li>
<li>缺点：一是加密的太简单了，二来没办法做到即时播放，一定要下载到手机上才可以播放，很鸡肋。  </li>
</ul>
</blockquote>
<p>加密代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.QingHeYang;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.BadPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.IllegalBlockSizeException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.KeyGenerator;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.NoSuchPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeMp4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String sourcePath = <span class="string">"E:/source.mp4"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String targetPath = <span class="string">"E:/target.mp4"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		encodeMp4();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encodeMp4</span><span class="params">()</span></span>&#123;</span><br><span class="line">		File sourceFile = <span class="keyword">new</span> File(sourcePath);</span><br><span class="line">		File targetFile = <span class="keyword">new</span> File(targetPath);</span><br><span class="line">		FileInputStream input = <span class="keyword">null</span>;</span><br><span class="line">		BufferedInputStream inBuff = <span class="keyword">null</span>;</span><br><span class="line">		FileOutputStream output = <span class="keyword">null</span>;</span><br><span class="line">		BufferedOutputStream outBuff = <span class="keyword">null</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;			</span><br><span class="line">			input = <span class="keyword">new</span> FileInputStream(sourceFile);</span><br><span class="line">			inBuff = <span class="keyword">new</span> BufferedInputStream(input);</span><br><span class="line">			output = <span class="keyword">new</span> FileOutputStream(targetFile);</span><br><span class="line">			outBuff = <span class="keyword">new</span> BufferedOutputStream(output);</span><br><span class="line"></span><br><span class="line">			outBuff.write(encrypt(<span class="string">"value"</span>, <span class="string">"key"</span>));</span><br><span class="line">			<span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">5</span>];</span><br><span class="line">			<span class="keyword">int</span> len;</span><br><span class="line">			<span class="keyword">while</span> ((len = inBuff.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">				outBuff.write(b, <span class="number">0</span>, len);</span><br><span class="line">			&#125;</span><br><span class="line">			outBuff.flush();</span><br><span class="line">			inBuff.close();</span><br><span class="line">			outBuff.close();</span><br><span class="line">			output.close();</span><br><span class="line">			input.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				outBuff.flush();</span><br><span class="line">				inBuff.close();</span><br><span class="line">				outBuff.close();</span><br><span class="line">				input.close();</span><br><span class="line">				output.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(String content, String password) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			KeyGenerator kgen = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">			kgen.init(<span class="number">128</span>, <span class="keyword">new</span> SecureRandom(password.getBytes()));</span><br><span class="line">			SecretKey secretKey = kgen.generateKey();</span><br><span class="line">			<span class="keyword">byte</span>[] enCodeFormat = secretKey.getEncoded();</span><br><span class="line">			SecretKeySpec key = <span class="keyword">new</span> SecretKeySpec(enCodeFormat, <span class="string">"AES"</span>);</span><br><span class="line">			Cipher cipher = Cipher.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">			<span class="keyword">byte</span>[] byteContent = content.getBytes(<span class="string">"utf-8"</span>);</span><br><span class="line">			cipher.init(Cipher.ENCRYPT_MODE, key);</span><br><span class="line">			<span class="keyword">byte</span>[] result = cipher.doFinal(byteContent);</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchPaddingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvalidKeyException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalBlockSizeException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (BadPaddingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加密效果还行吧，只能说能糊弄一下不懂的人，效果如图。<br>未加密的二进制文件：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic2.png" alt="未加密"><br>加密的二进制文件对比：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic1.png" alt="加密"><br>在头部加了AES-128加密的字符，其实不一定在头部加，可以在任意地方加，就强度来说，还算可以。<br>但是有一个问题，因为我用的ijkPlayer，这个播放器是用ffmpeg编译解码器，然后用ffplay播放画面，输出到android的surfaceView上面的，所以，在Java的api层面，是<strong>找不到对这个文件进行流的操作</strong>的。<br>所以，这就涉及到另一个问题，我该怎么播放了，众所周知的是，无论是VideoView还是市面上的ijk也好，vitamio，更原始一点的surfaceView，都有setVideoPath这个api，都没有ImageView的类似setStream这种对文件流的操作。<br>所以，这就意味着阻断了在Java的api的对视频文件的流操作（我是真的追源码了，最后追到jni层，没法继续下去了），也就意味着没法编解码边播放了，只能下载下来，然后用File的方法，进行decode，这样不是很友好的，因为，一但下载下来，再decode，这样一是浪费了Android手机宝贵的内存控件，二来，解密完后，视频源文件不还是成了未加密的了吗！这不是白玩了吗。<br>其实也不是不能边解密边播，但是目前来，我的水准还是达不到的，但是大致思路就是，用ijkPlayer编译的过程自定义视频解码器，把自己的视频解码器替换调mp4的解码器，这样，能做到边解密边播（很遗憾，水平不够）。  </p>
<hr>
<h1 id="HLS视频流"><a href="#HLS视频流" class="headerlink" title="HLS视频流"></a>HLS视频流</h1><p>放弃掉mp4解密的大坑后，我转战HLS流的形式。<br>这个形式，好处很多，市面上最流行的，文件加密性好，有链保护，获取不到源文件，获取到了，外行也不会操作，balabala….<br>说一下优缺点：  </p>
<blockquote>
<ul>
<li>优点：技术成熟，会编译，明白原理基本就ok了，加密性好。  </li>
<li>缺点：不好说，这个缺点多半是我自身缺点，水平有限。  </li>
</ul>
</blockquote>
<p>做HLS视频流要准备一些东西，我列一下：  </p>
<blockquote>
<ul>
<li>linux：要用到这个编译ffmpeg，看一下ffmpeg官网，windows也可以，不过会很麻烦。</li>
<li>ffmpeg源码：下载下来要编译的。</li>
<li>ijkPlayer源码：播放加密视频用。<a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">点击这里去ijkPlayer</a>。</li>
<li>mp4源文件：原材料要准备好。</li>
<li>tomcat/nginx/apache：服务器，必需品，hls中key文件，以及视频文件都需要用到。</li>
</ul>
</blockquote>
<h2 id="HLS文件构成"><a href="#HLS文件构成" class="headerlink" title="HLS文件构成"></a>HLS文件构成</h2><p>先说一下hsl加密视频流的组成内容：  </p>
<blockquote>
<ul>
<li>.m3u8文件：视频索引文件。  </li>
<li>.ts文件：视频片段。  </li>
<li>.key文件：加密秘钥（AES-128，同mp4加密用的一样的手段）。  </li>
<li>.keyInfo：加密时用的文件，写入.m3u8里面的过程文件。</li>
</ul>
</blockquote>
<p>HLS是基于MP4生成的，将mp4文件切片，在对每一个切片文件加密，然后将这些切片文件的序列进行集合，生成索引文件.m3u8，一个完整的HLS视频流如下图所示：<br>未加密：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic4.png" alt="未加密">  </p>
<p>加密：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic5.png" alt="加密"><br>未加密的.ts文件可以用播放器直接打开，且在切片的时候不能修改后缀名。<br>加密的.ts文件不可以直接用播放器打开，可以在生成切片文件时候修改后缀名。<br>.m3u8文件的内容如下，这个我就只上加密的了，毕竟这个是重点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:35</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI=&quot;http://ubuntu.shouwangzhe.space/video/source2lock/source2.key&quot;,IV=0x67e6af3d7b4117a01831d6b3a8741df1</span><br><span class="line">#EXTINF:34.661933,</span><br><span class="line">source2_0_ts</span><br><span class="line">#EXTINF:26.736822,</span><br><span class="line">source2_1_ts</span><br><span class="line">#EXTINF:29.197778,</span><br><span class="line">source2_2_ts</span><br><span class="line">#EXTINF:31.658733,</span><br><span class="line">source2_3_ts</span><br><span class="line">#EXTINF:33.827711,</span><br><span class="line">source2_4_ts</span><br><span class="line">#EXTINF:32.534667,</span><br><span class="line">source2_5_ts</span><br><span class="line">#EXTINF:22.106889,</span><br><span class="line">source2_6_ts</span><br><span class="line">#EXTINF:5.797844,</span><br><span class="line">source2_7_ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure></p>
<h2 id="编译ffmpeg"><a href="#编译ffmpeg" class="headerlink" title="编译ffmpeg"></a>编译ffmpeg</h2><p>因为这块遇到了些问题，但是最终解决了，就简单说一下步骤，ffmpeg编译网络上有很多教程的。<br>1.先安装gcc+yasm，这个比较重要，必备。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt-get install gcc</span><br><span class="line">$ sudo apt-get install yasm</span><br></pre></td></tr></table></figure></p>
<p>2.下载ffmpeg，地址<a href="http://ffmpeg.org/download.html" target="_blank" rel="noopener">点击这里</a>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ffmpeg</span><br><span class="line">$ <span class="built_in">cd</span> ffmpeg</span><br><span class="line">$ git <span class="built_in">clone</span> https://git.ffmpeg.org/ffmpeg.git ffmpeg</span><br></pre></td></tr></table></figure></p>
<p>3.编译ffmpeg。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ffmpeg</span><br><span class="line">$ ./configure --<span class="built_in">enable</span>-shared --<span class="built_in">disable</span>-static --<span class="built_in">disable</span>-doc</span><br></pre></td></tr></table></figure></p>
<p>然后会执行很久，完成之后make。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">$ make clean</span><br></pre></td></tr></table></figure></p>
<p>之后就完成了，大致内容如下<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic3.png" alt="ffmpeg"><br>然后就是对视频的操作了。  </p>
<h2 id="加密视频"><a href="#加密视频" class="headerlink" title="加密视频"></a>加密视频</h2><p>1.准备好一个source.mp4文件，用于加密，放置在一个文件夹下面，准备好两个文件夹，一个放置加密的，一个放置未加密的，大致如下：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic6.png" alt="文件夹"><br>2.生成要加密的key，前提要有openssl。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> source2lock</span><br><span class="line">$ openssl rand 16 &gt; source2.key</span><br><span class="line">$ cat source2.key</span><br></pre></td></tr></table></figure></p>
<p>保存下生成的这个偏移量。<br>3.生成偏移量 IV。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rand -hex 16 &gt;source2.iv.txt</span><br></pre></td></tr></table></figure></p>
<p>4.生成hls_key_info_file。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ touch source2.keyinfo</span><br><span class="line">$ vi source2.keyinfo</span><br></pre></td></tr></table></figure></p>
<p>5.用vi写入如下内容。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#你要存秘钥的地址，最好是个网络地址</span></span><br><span class="line">http://ubuntu.shouwangzhe.space:1994/video/source2lock/source2.key</span><br><span class="line"><span class="comment">#刚才你生成的key文件</span></span><br><span class="line">source2.key</span><br><span class="line"><span class="comment">#刚才你保存的偏移量</span></span><br><span class="line">67e6af3d7b4117a01831d6b3a8741df1</span><br></pre></td></tr></table></figure></p>
<p>6.视频切片+加密，<strong>记得将这些命令写到一行上去</strong>，我这么些是因为容易看一些。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg  </span><br><span class="line">-i ../source2.mp4 </span><br><span class="line">-vcodec copy </span><br><span class="line">-acodec copy </span><br><span class="line">-vbsf h264_mp4toannexb </span><br><span class="line">-hls_time 30 </span><br><span class="line">-hls_key_info_file source2.keyinfo </span><br><span class="line">-hls_playlist_type vod </span><br><span class="line">-hls_segment_filename <span class="string">"source2_%d_ts"</span> source2_list.m3u8</span><br></pre></td></tr></table></figure></p>
<p>出现以下结果就成功了,<strong>注意小红框的内容,crypto</strong>，后续用的到<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic7.png" alt="文件夹"><br>7.视频未加密，也顺带给上一个未加密的命令吧。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg  </span><br><span class="line">-i ../source2.mp4 </span><br><span class="line">-codec copy </span><br><span class="line">-vbsf h264_mp4toannexb </span><br><span class="line">-map 0 </span><br><span class="line">-f segment </span><br><span class="line">-segment_list source2_list.m3u8 </span><br><span class="line">-segment_time 30 source2_%d.ts</span><br></pre></td></tr></table></figure></p>
<h2 id="转为在线视频流"><a href="#转为在线视频流" class="headerlink" title="转为在线视频流"></a>转为在线视频流</h2><p>有加密视频文件了，就需要一个http服务器来支撑播放。<br>大致有三种方式，一种比一种简单：</p>
<blockquote>
<ul>
<li>nginx：vi /etc/nginx/sites-avaliable/default 就ok，配置端口，静态文件夹</li>
<li>tomcat：最常用的一种，将视频文件夹扔到webapps下面即可，然后./startup就ok的。</li>
<li>apache：也是经常用到的http服务器，但是我没用过，就不详谈了。</li>
</ul>
</blockquote>
<p>但是无论上述哪一种一定记得，key所在的位置就是刚才加密视频的时候编写hls_key_info_file里面key的位置。</p>
<h2 id="播放加密视频"><a href="#播放加密视频" class="headerlink" title="播放加密视频"></a>播放加密视频</h2><p>加密完视频后，可以算是成功一半了，剩下的就是解密视频了。<br>我记得ijkPlayer支持播放加密的m3u8的问题，于是乎，我直接把视频地址扔进ijkPlayer中，想着应该大功告成了，但是天道好轮回，苍天绕过谁。<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic8.png" alt="ffmpeg"><br>提示是我自己编写的，ijkPlayer是我曾经编译的。<br>经过研究发现个问题，我这个ijk，好像不支持加密的hls啊！<br>上一下当时的loagcat：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic9.png" alt="ffmpeg"><br>可以看到第一，我的key没有问题，第二视频列表已经索引出来了。<br>但是唯独加载不出来视频片段1。<br>经过我漫长的寻找解决答案，终于碰到了个明白人，解决了我解密hls播放不出来的问题。<br>地址：<a href="https://segmentfault.com/q/1010000006751909" target="_blank" rel="noopener">https://segmentfault.com/q/1010000006751909</a><br>因为在我ijk编译的过程中，选择的最简略的解码器，外加协议上面没有添加多种协议。<br>所以，我重新编译了ijkPlayer。<br>因为过程太过复杂，具体请看github上面的教程。<br>地址：<a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">https://github.com/bilibili/ijkplayer</a><br>这里我给一下我服务器上面的已经编译好的包，免去繁琐的编译过程啦。<br>ijk编译好的包下载地址：<a href="http://www.qingheyang.studio:8000/ijkplayer_hls加密.zip" target="_blank" rel="noopener">点击下载</a><br>具体用法请自行百度。<br>上一下贼简单的activity代码(不然证明不了我是Android程序员啊)：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sohero.com.testhlsvideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sohero.com.testhlsvideo.video.media.IjkVideoView;</span><br><span class="line"><span class="keyword">import</span> tv.danmaku.ijk.media.player.IMediaPlayer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    IjkVideoView vv;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        vv = (IjkVideoView) findViewById(R.id.ijk_vv);</span><br><span class="line">        vv.setVideoPath(<span class="string">"http://192.168.31.222:8090/coursePackage/hls/lock/source2_list.m3u8"</span>);</span><br><span class="line">        vv.setOnPreparedListener(<span class="keyword">new</span> IMediaPlayer.OnPreparedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(IMediaPlayer iMediaPlayer)</span> </span>&#123;</span><br><span class="line">                vv.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>效果图：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-04-16/pic10.png" alt="效果图">  </p>
<h2 id="将来的方向"><a href="#将来的方向" class="headerlink" title="将来的方向"></a>将来的方向</h2><p>这套还是有些问题的，例如对key文件保存的不周到，加密的不够好，懂行的人也是能获取全链的，等等等等。<br>将来的方向我还是想着以操作m3u8文件为主，对视频链路进行保护，着重保护key文件，二次加密等等，现在先这样，等想出来我再补充。  </p>
<hr>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>全部搞完历时三天，从不明白HLS，到最后实现出来，总体来说还是挺有成就感的，这大概就是做一个开发工程师的快乐所在吧，如果这篇文章有幸被你看到了，你有什么不懂的地方欢迎留言，我写的毕竟还是太粗糙了，我会尽我所能去帮你，就这样。<br>以上</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/a137cd06.html" data-id="ckag2slmj000syisu6foefge6" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HLS/">HLS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ijkPlayer/">ijkPlayer</a></li></ul>

    </footer>

  </div>

  

  

</article>



      
        <article id="post-Hexo博客那点事，一些技术上的延伸" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/bd8a7f1a.html">Hexo博客那点事，一些技术上的延伸</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/bd8a7f1a.html" class="article-date">
  <time datetime="2019-02-24T09:56:00.000Z" itemprop="datePublished">2019-02-24</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/综合技术/">综合技术</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>2018年年初的时候我弄得hexo博客，到现在满打满算1年多，在上半年用的比较多，下半年我就销声匿迹了，很少写，这与懒不懒惰无关，是因为我自己的服务器遭受到了重创，数据全部被清空了，也就是说，我个人的服务全都挂了。<br>大概就是自己弄得文件系统、博客系统、游戏服务、还有一大堆费心写的费心编译的项目，全GG，至于为什么没有备份，因为那是我自己用旧电脑改装的服务器啊喂！！！<br>我眼前还浮现着之前美滋滋弄得漂亮的博客的样子，就是下面这个样子，我还完善了很多漂亮的主题。<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic1.jpg" alt><br><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic2.jpg" alt="mark"><br>后来因为之前把博客部署到github.io了，所以文字性的东西勉强还算能够找到，图片是废了，更别说我的tomcat服务了。<br>最后总结出来一个，ubuntu经不起突然断电的折腾，因为有一天突然停电了，我的服务器就挂了，痛定思痛，我今年决定把博客再给前捡起来，然后在做一系列的风控措施吧，虽然我也不是运维，hahahaha。  </p>
<hr>
<h1 id="框架"><a href="#框架" class="headerlink" title="框架"></a>框架</h1><p>首先说一下，这篇博文主要是说一下<strong>hexo博客的延伸，需要有一定的linux基础以及会部署hexo项目的经验，最好有一些网络经验</strong>。<br>我研究了一下我要做到什么样子，才算是能让我觉得满意的博客。  </p>
<blockquote>
<ul>
<li>服务器：首先是在自己的服务器上面进行操作。  </li>
<li>Hexo主体：这块就介绍一下要安的包。</li>
<li>主题：这块就比较鸡肋了，一般会部署的都会切换主题。  </li>
<li>资源：博客的资源操作，要怎么用。  </li>
<li>自动化：必须能够做到能够自动generate，自动deploy，以及backup，否则一切免谈。  </li>
<li>网络：项目部署后，要有自己的域名，而且要ssl证书的那种。（要求太过分了，hahahaha）</li>
</ul>
</blockquote>
<p>上面这些是我能想到的，还有些可能没有理清的，后续再说吧。  </p>
<hr>
<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><p>如果你只是想部署一个hexo项目，并且只会选择github.io作为主站点，那你可以点击右上角，然后去找一找比别的教程了。<br>服务器是整个项目必备的，而且一般都是linux，可以有以下几种选择。  </p>
<blockquote>
<ul>
<li>云服务器：优点是可以<strong>icp，固定ip</strong>（这就很舒服了），缺点也很明显，贵啊。 </li>
<li>自己搭建服务器：优点，自己可控，随意造，最重要的是，随随便便的<strong>i7+16G</strong>内存，无论做什么，编译速度不是完爆1核1G1Mb了，缺点就是，这个对你网络的运营商要求比较高。还有一点是，如果你家里网可以翻墙，自己的服务器还是有些优势的。  </li>
</ul>
</blockquote>
<p>很明显我选择的第二种，因为考虑到性能问题（qiong），我当初做的服务器就是用旧电脑搭建的，就是下面这个。<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic3.jpg" alt><br>还有我的运维环境，毕竟是在家里，不要在意那么多。<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic4.jpg" alt><br>服务器系统是ubuntu server，经历过断电后，我就选择了server系统，而不用普通的ubuntu了，没有用centOS，因为对Debian这系列有好感，小版本是18.0.4。<br>安装教程可以自行百度，可以<a href="https://blog.csdn.net/zhengchaooo/article/details/80145744" target="_blank" rel="noopener">参照这个</a>。  </p>
<hr>
<h1 id="Hexo主体"><a href="#Hexo主体" class="headerlink" title="Hexo主体"></a>Hexo主体</h1><p>考虑到网络上太多的Hexo教程，以及能研究到延伸这里的，基本都是会的，不过我还是贴心的给挂上几个连接，以及一定要安装的一些包。  </p>
<ul>
<li><a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="noopener">Hexo官网文档（免去你一会去百度了）</a></li>
<li><a href="https://hexo.io/themes/" target="_blank" rel="noopener">Hexo Themes 地址，主题地址（有时候得挂一下代理）</a> </li>
<li><a href="https://hexo.io/plugins/" target="_blank" rel="noopener">Hexo 插件地址</a>  </li>
</ul>
<p>其实安装的话，看官网教程就可以了，如果你会一些linux知识，当然你要会前端那就更NB了。<br>先安装npm、nodeJs、以及hexo。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install nodejs  </span><br><span class="line">$ npm install -g hexo-cli</span><br></pre></td></tr></table></figure></p>
<p>好像是上面这样，网上教程很多的，因为太久远了，有些忘了，不过这些也不是重点。<br>插件大概有一些。<br>hexo-admin，必装，因为这个编辑真的很舒服，<a href="https://github.com/jaredly/hexo-admin" target="_blank" rel="noopener">教程点这里</a>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save hexo-admin</span><br></pre></td></tr></table></figure></p>
<p>效果如下：  </p>
<p><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic6.png" alt><br>hexo-deployer-git,必装，hexo部署到github.io的插件，<a href="https://github.com/hexojs/hexo-deployer-git" target="_blank" rel="noopener">教程点这里</a>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></p>
<p>暂时想这么多，后续再补吧。  </p>
<hr>
<h1 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h1><p>我感觉这块大家都明白，如果你懂一些前端知识，还是可以在人家已有的主体上面给修改一些东西的。<br>例如之前这个主题的代码字体不好看，可以去对应的主题下面，找到css文件，修改一下颜色，网页中按f12，查看具体的位置，其实我是真不太懂这块的，连蒙带侃的找到了对应的位置，修改了颜色。<br>我这个主题是<a href="https://github.com/Fechin/hexo-theme-diaspora" target="_blank" rel="noopener">Diaspora</a>，我还是觉得挺好看的。  </p>
<hr>
<h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><p>这个资源怎么说呢，主要就是图片，音频，因为曾经博客丢失过，所以我就决定，弃用hexo自带的assert资源文件夹了，这个文件夹是文章对应的图片文件夹。<br>这个主要是要是整个项目丢了，那简直是灾难，所以我决定图片内文章全用图床形式，网络图片。<br>图床有几种选择：  </p>
<blockquote>
<ul>
<li>七牛  </li>
<li>存储桶  </li>
<li>github  </li>
<li>自建http服务器。  </li>
</ul>
</blockquote>
<p>很明显，我也选择的最后一种，大概是程序员的执拗，我一向喜欢用自己的服务器。<br>其实我也纠结了很久哪个更好点，毕竟除了自建服务器，其余的都是https协议（后面解释原因），也不花钱，但是我还是太懒了，hahahaha。<br>最后我选择了自己搭建nginx服务器，因为以前做ffmpge用到过，比tomcat更符合我的风格。<br>话不多说，先安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install nginx</span><br></pre></td></tr></table></figure></p>
<p>然后配置，此处需要权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/nginx/sites-available/default</span><br></pre></td></tr></table></figure></p>
<p>然后配置静态路径，具体内容需要修改为自己想开方的路径以及端口号：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        listen [::]:80 ipv6only=on default_server;</span><br><span class="line"></span><br><span class="line">        root /var/www/html;</span><br><span class="line">        index index.html index.htm index.nginx-debian.html;</span><br><span class="line">        charset utf-8;</span><br><span class="line">        server_name _;</span><br><span class="line"></span><br><span class="line">        location / &#123;  </span><br><span class="line">                root /home/qingheyang/share/;</span><br><span class="line">                autoindex on;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后开启 or 重启：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nginx -S reload</span><br></pre></td></tr></table></figure></p>
<p>如果你最后在浏览器输入你自己的ip或者域名，加nginx监听的端口号，能看到下面结果，说明成功了。<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic7.png" alt><br>然后就可以在文章中引用了，需要注意的是，这些图片不能丢失，否则文章中图就挂了。<br>当然，这仅仅是我的选择，其实github，或者七牛都是不错的选择。毕竟稳定，不收费。<br>（2019-04-18补充）<br>其实markdown也可以上传视频的，通过下列代码插入到.md文档中就可以了：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">' '</span> <span class="attr">type</span>=<span class="string">'video/mp4'</span> <span class="attr">controls</span>=<span class="string">'controls'</span>  <span class="attr">width</span>=<span class="string">'100%'</span> <span class="attr">height</span>=<span class="string">'100%'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h1 id="自动化"><a href="#自动化" class="headerlink" title="自动化"></a>自动化</h1><p>无论何时，其实都可以考虑自动化，除去不长期开着项目的，只往github上更新的童鞋。  </p>
<h2 id="一键上传博客"><a href="#一键上传博客" class="headerlink" title="一键上传博客"></a>一键上传博客</h2><p>我在去年的一篇文章里写了怎么用expect做到一键更新项目到github.io上去，再贴一下脚本吧。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#脚本里的用户名密码都需要修改</span></span><br><span class="line"><span class="comment">#!/usr/bin/expect -f</span></span><br><span class="line"><span class="built_in">set</span> gitUser QingHeYang</span><br><span class="line"><span class="built_in">set</span> gitPsw *******</span><br><span class="line"><span class="built_in">set</span> userPsw *******</span><br><span class="line"></span><br><span class="line">spawn ssh qingheyang@localhost</span><br><span class="line">expect <span class="string">"password:"</span> &#123;send <span class="string">"<span class="variable">$userPsw</span>\r"</span>&#125;</span><br><span class="line">expect <span class="string">"qingheyang@*"</span>  &#123;send <span class="string">"cd /home/qingheyang/Hexo/QHY_Blog2\r"</span>&#125;</span><br><span class="line">expect <span class="string">"qingheyang@*"</span>  &#123;send <span class="string">"hexo g\r"</span>&#125;</span><br><span class="line">expect <span class="string">"qingheyang@*"</span>  &#123;send <span class="string">"hexo d\r"</span>&#125;</span><br><span class="line">expect <span class="string">"*Username*"</span>  &#123;send <span class="string">"<span class="variable">$gitUser</span>\r"</span>&#125;</span><br><span class="line">expect <span class="string">"*Password*"</span>  &#123;send <span class="string">"<span class="variable">$gitPsw</span>\r"</span>&#125;</span><br><span class="line"></span><br><span class="line">expect eof</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure></p>
<p>编辑完后，记得：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 脚本.sh u+x</span><br></pre></td></tr></table></figure></p>
<p>然后执行一下，你会发现，系统自动登陆，然后给你自动输入密码然后把项目deploy到github.io上去了。<br>这个有前提的，一定要配置hexo-deployer-git。  </p>
<h2 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h2><p>计划任务主要是要做备份用，将整个项目以及网络资源还有服务器的部分内容，按时给备份到某一个地方去。<br>这回我给我的博客加上了备份功能， 因为静态页可以随时随地查看，但是静态页是没法反向转成项目工程的，一但项目工程丢失了，你的博客也就止步于此了。<br>所以备份必不可少，怎么备份呢，我的思路大概是：  </p>
<blockquote>
<p>1 .将自己的Hexo博客源文件夹以及图床文件夹，拷贝到一个目录中（也可以带入服务器比较关键的文件）。<br>2 .将这些文件压缩。<br>3 .将压缩文件上传。  </p>
</blockquote>
<p>技术点是：  </p>
<blockquote>
<p>1 .用ubuntu自带的计划任务，每周一、周四执行备份命令与脚本。<br>2 .用阿里云sdk上传至阿里云OSS中。  </p>
</blockquote>
<h3 id="计划任务-1"><a href="#计划任务-1" class="headerlink" title="计划任务"></a>计划任务</h3><p>什么是计划任务，计划任务是ubuntu定时执行的命令，具体教程可以<a href="https://blog.csdn.net/qq_38228830/article/details/80545004" target="_blank" rel="noopener">参照这个</a>,我定的是每周一周四，18:20开始备份，18:40截止备份。<br>计划任务具体操作如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp; crontab -e</span><br></pre></td></tr></table></figure></p>
<p>然后让你选择用哪个编辑器，有nano，有vi，我手滑了，选的nano，界面如下：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic8.png" alt><br>里面的白字是我手动输入的，注意，计划任务的命令最好用<strong>绝对路径</strong>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第5步，18:40执行上传文件到OSS的jar包</span></span><br><span class="line">40 18 * * 1,4 /home/qingheyang/Java/jdk1.8.0_181/bin/java -jar /home/qingheyang/server_back_up/utils/utils.jar</span><br><span class="line"><span class="comment"># 第4步，18点30压缩备份文件夹</span></span><br><span class="line">30 18 * * 1,4 zip -r /home/qingheyang/server_back_up/zipfile/backup.zip /home/qingheyang/server_back_up/sourcefile</span><br><span class="line"><span class="comment"># 第3步，18:27 复制我的世界文件夹进入备份文件夹</span></span><br><span class="line">27 18 * * 1,4 /bin/cp -r /home/qingheyang/minecraft/newworld /home/qingheyang/server_back_up/sourcefile/minecraft</span><br><span class="line"><span class="comment"># 第2步，18:25 复制图床文件进入备份文件夹</span></span><br><span class="line">25 18 * * 1,4 /bin/cp -r /home/qingheyang/share/blog_image /home/qingheyang/server_back_up/sourcefile/blog</span><br><span class="line"><span class="comment"># 第1步，18:20 复制博客工程进入备份文件夹</span></span><br><span class="line">20 18 * * 1,4 /bin/cp -r /home/qingheyang/Hexo/QHY_Blog2 /home/qingheyang/server_back_up/sourcefile/blog</span><br></pre></td></tr></table></figure></p>
<p>然后输入 Ctrl+o ，写入文件即可，按Ctrl + x，退出nano编辑器，然后重启计划任务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service cron restart</span><br></pre></td></tr></table></figure></p>
<p>可以输入命令查看当前用户的计划任务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crontab -l</span><br></pre></td></tr></table></figure></p>
<p><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic9.png" alt>  </p>
<h3 id="云备份"><a href="#云备份" class="headerlink" title="云备份"></a>云备份</h3><p>（2019/04/16补）<br>定期打出来的压缩包是可以上传到某一个地方去的，有很多种选择，因为我域名是在阿里云买的，所以我就选择了阿里云的OSS存储器，价格低，很低很低，也方便管理，他有sdk给提供。<br>我做了个Java工程，打了个jar包，就当做是脚本来运行了。  </p>
<blockquote>
<p>阿里云OSS地址：<a href="https://www.aliyun.com/product/oss?spm=5176.8142029.selected.3.fbcf6d3eyuSIHf" target="_blank" rel="noopener">https://www.aliyun.com/product/oss?spm=5176.8142029.selected.3.fbcf6d3eyuSIHf</a>  </p>
</blockquote>
<p>贴一下java代码，最简单的文件上传：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.qhy.backup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadBackupFile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		String endpoint = <span class="string">"http://oss-cn-beijing.aliyuncs.com"</span>;</span><br><span class="line">		String accessKeyId = <span class="string">"&lt;你的accessKey&gt;"</span>;</span><br><span class="line">		String accessKeySecret = <span class="string">"&lt;你的accessKeySecret&gt;"</span>;</span><br><span class="line">		OSSClient ossClient = <span class="keyword">new</span> OSSClient(endpoint, accessKeyId,</span><br><span class="line">				accessKeySecret);</span><br><span class="line">     <span class="comment">//地址一定要选绝对路径地址，不然会出错误</span></span><br><span class="line">		String backupPath = <span class="string">"/home/qingheyang/server_back_up/zipfile/backup.zip"</span>;</span><br><span class="line">		Calendar c = Calendar.getInstance();</span><br><span class="line">		c.setTime(<span class="keyword">new</span> Date());</span><br><span class="line">     <span class="comment">//以时间命名的备份文件</span></span><br><span class="line">		String fileName = (<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd-HH:mm:ss"</span>))</span><br><span class="line">				.format(c.getTime()) + <span class="string">"_backupfile.zip"</span>;</span><br><span class="line">		ossClient.putObject(<span class="string">"&lt;你新建的bucket名称&gt;"</span>, fileName, <span class="keyword">new</span> File(backupPath));</span><br><span class="line">		ossClient.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过引入阿里云的sdk,然后打成jar包，扔进服务器，最后通过计划任务java -jar定时运行就可以了。<br>效果如下：<br><img src="http://www.qingheyang.studio:8000/blog_image/2019-03-12/pic10.png" alt><br>这是已经上传好的备份文件，阿里云也提供下载功能，具体代码编写就不贴了，有教程的，而且，服务器如果不崩溃的话，是用不到的。  </p>
<p>这样通过上述两步，定时将博客重要的文件备份上传就完成了，总结一下问题：  </p>
<blockquote>
<ul>
<li>还不完备，其实可以都写到java里面，然后一步执行即可，现在这样写存在异步的问题，有可能这边没压缩完，下一个计划任务就已经开始上传了，只不过我懒得写代码了，给预留的时间也足够，hahaha.  </li>
<li>OSS既然应用了，其实这个博客可以实现的很简单，我也没必要将他上传到github.io中去了，当一个静态存储桶也是够的。  </li>
<li>最大的问题就是，写的不够清晰明了，我省略了很多步骤，其实这篇文章可以细分很多很多方向，但我给集合到一起了，效果不是很好。</li>
</ul>
</blockquote>
<hr>
<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><p>这个可以重点说一下，因为这块涉及到域名、端口号、ssl证书等一系列的问题。  </p>
<h2 id="服务器网络"><a href="#服务器网络" class="headerlink" title="服务器网络"></a>服务器网络</h2><p>先说一下前提：<strong>你没有自己的云服务器</strong>，可能因为qiong，也可能因为你跟我有一样，有废弃的性能比较好的电脑，这是大前提，<strong>如果你有云服务器，不管是阿里云ECS，还是亚马逊AWS，你可以省略这块了，整篇文章对你来说都没有意义</strong>。  </p>
<p>自建服务器有个很大的缺点，就是非固定ip，甚至有可能是非公网ip。<br>这就涉及到很严重的问题，如果非公网ip，就意味着你的博客外网访问不到，因为网络是一层套一层的，你的服务器链接你的路由器，你的路由器连接着外网，这是必备条件。<br>如果你的运营商可以提供公网ip，但是你查询到的ip不是公网ip，那就需要你做一些措施了。<br>具体怎么查询呢，首先你需要连接上自己的wifi，然后百度一下，ip，然后看一下结果，然后登录自己的路由器，看一下ip，如果一致，恭喜你，运营商还算良心，如果不一致，可以致电运营商，讨要公网ip，没错，你有这个权利的。<br>有公网ip后，你需要在路由器进行端口映射，具体的方法，要看什么路由器了，需要映射的端口号有这些：  </p>
<blockquote>
<ol>
<li>22端口:远程ssh以及ftp必备。  </li>
<li>80端口:nginx监听的默认是80.其实可以修改的，对外接口一定不能是80，政策不给你开80端口的。</li>
<li>4000端口:hexo服务器默认端口，作用是你想随时随地编写博客，就得一直开着。</li>
</ol>
</blockquote>
<p>映射出去后，就可以远程对这些进行操作了。<br>最后的效果是，将自己的域名绑定ip，然后编写完博客后deploy到github.io上去，然后阿里云域名直接指向githu.io，做到个人域名访问发布的博客，最后一部是添加ssl证书。<br>达到现在这个博客的样子。<br>因为涉及到太多东西了，所以我有点不知道怎么写了，以后慢慢补吧，先告一段落。</p>
<hr>
<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>其实还有很多要写，seo站点优化，提交给百度及谷歌，添加访问量等等等等，但是有点写不下去了，先写写别的，如果我的这篇文章有幸被你看到了，有什么不明白的地方，可以通过留言告诉我，尽我所能去帮你。<br>啊对了，说一下我现在的这个效果吧：  </p>
<blockquote>
<ol>
<li>我可以在任何一个地方编写我的博客，地址是<a href="http://www.qingheyang.studio:1314" target="_blank" rel="noopener">http://www.qingheyang.studio:1314</a>。  </li>
<li>每周自动准时备份，备份完成后会给我发送短信。  </li>
</ol>
</blockquote>
<p>就这样，以上</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/bd8a7f1a.html" data-id="ckag2sll60006yisuxjlbmkga" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/">hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>

    </footer>

  </div>

  

  

</article>



      
        <article id="post-关于互联网技术" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/dc492ad2.html">关于互联网技术</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/dc492ad2.html" class="article-date">
  <time datetime="2018-12-04T09:38:00.000Z" itemprop="datePublished">2018-12-04</time>
</a>
        
      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <p>互联网技术  </p>
<ol>
<li>前端：android\ios，react，jsp，vue。</li>
<li>后端：java js .net C#。</li>
<li>dba：mysql oracle mangodb。  </li>
<li>运维：windows server 、 linux 、 tomcat 、Apache 、nginx、docker。</li>
<li>new tech. : hadoop、tensorflow、caffe。</li>
<li>混合：react native 、pwa、flutter(update in 2019/04/24)。  </li>
</ol>
<p>我就是想列一下存在的这些技术，可能你比我明白，要是写错的地方，让您见笑了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/dc492ad2.html" data-id="ckag2sllt000dyisus2ul7yw9" class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  

</article>



      
        <article id="post-关于机器学习的一些想法(持续更新中)" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/7b334ee0.html">关于机器学习的一些想法(持续更新中)</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/7b334ee0.html" class="article-date">
  <time datetime="2018-05-23T09:43:00.000Z" itemprop="datePublished">2018-05-23</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/New-Life/">New Life</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <p>我现在的情况是处在半迷茫阶段了。<br>我已经24了，今年结的婚，算是结婚尚早的。<br>不提个人生活，我在工作上面也存在很大的迷茫，不知道该往哪个方向走。<br>前段日子定下了走人工智能，这算是我自主学习的半年来定下的结果吧。  </p>
<hr>
<p>现在在学习人工智能，罗列一下现在掌握的信息：  </p>
<ul>
<li>人工智能的本质是模型。  </li>
<li>模型有很多，需要自己来通过高等数学来编写。  </li>
<li>框架是tensorflow，或者caffe。  </li>
<li>tensorflow需要用到的是python。  </li>
<li>目前刚刚学习了决策树。  </li>
<li>损失函数、激活函数。  </li>
<li>卷积CNN原理，降维、反向传播、共享权值、纹理。  </li>
</ul>
<p>其实想学人工智能这个方面也跟我小时候的执念有关，哪个孩子心底不存在一个人工智能的梦啊。<br>既然父母把我放出来了，我就不想着去做生意了，我要选择的不是一个三流的执行工程师，而是一个真正的工程师。  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/7b334ee0.html" data-id="ckag2slly000gyisuonshym5u" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AI/">AI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/生活/">生活</a></li></ul>

    </footer>

  </div>

  

  

</article>



      
        <article id="post-为Mac打造一个顺手的链接Linux工具" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/e8e9078e.html">为Mac打造一个顺手的链接Linux工具</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/e8e9078e.html" class="article-date">
  <time datetime="2018-03-15T08:19:00.000Z" itemprop="datePublished">2018-03-15</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/Utils/">Utils</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Mac的话也买了有一段时间，2017款的，作为一个Android程序员，虽然买苹果的本子会让人觉得有种投敌的感觉，但是不得不说，真的实在是太好用了。<br>作为一个Android程序员，怎么能离开Linux呢？无论是NDK还是.so库的编译，再到ffmpeg，都需要用到Linux。<br>因为朋友的关系，我对Linux还算比较熟悉，能够使用基本的命令，cd ，ls -al，htop这些命令就不说了，makefile也写过部分，脚本也写过一部分，不过应用场景较少罢了。<br>那么问题就来了，与Linux同源的Mac OS会不会对Linux开发有着更好的支持。<br>
        
          <a class="article-more-link" href="/archives/e8e9078e.html">阅读全文</a>
        
      
    </p></div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/e8e9078e.html" data-id="ckag2sllo000cyisujshjdbek" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>

    </footer>

  </div>

  

  

</article>



      
        <article id="post-RxJava2关于Junit的错误解决方法" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 itemprop="name">
      <a class="article-title" href="/archives/63f8e5ec.html">RxJava2关于Junit的错误解决方法</a>
    </h2>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/archives/63f8e5ec.html" class="article-date">
  <time datetime="2018-02-07T05:20:00.000Z" itemprop="datePublished">2018-02-07</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/移动端/">移动端</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      

      

      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>这段时间做的项目用到了RxJava2，整体框架为MVP。<br>因为我公司的电脑差的厉害，没有硬件加速，项目环境起步就是5.0，所以只能用真机调试，公司的测试机比电脑还差，慢的要死，种种问题的压迫。<br>我一拍脑门，决定Junit来进行测试我的P层逻辑，反正数据这种东西，测试通的过,到真机上面基本也就是刷新视图界面的问题了。  </p>
<hr>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>在整体coding的过程中还是遇到了部分棘手的问题，因为以往很少用Junit，应该说从来没有用过，所以踩了很多坑，我遇到的问题是在单元测试的过程中，无法用Rxjava2进行测试，而我MVP的主要核心就是Rxjava2，本文也主要是解决这个问题。<br>
        
          <a class="article-more-link" href="/archives/63f8e5ec.html">阅读全文</a>
        
      
    </p></div>
    <footer class="article-footer">
      <a data-url="http://blog.qingheyang.studio/archives/63f8e5ec.html" data-id="ckag2sll90008yisu2d41pkj4" class="article-share-link">分享</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>

  </div>

  

  

</article>



      
  </article>
  
  
    <nav class="page-nav">
      
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
    </nav>
  
</section>
</div>

  <footer class="footer">
  
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 清河阳</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>

<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/ocean_qingheyang.png" alt="清河阳"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>

<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
    </li>
  </ul>
</nav>

<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
<script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>


  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/search.js"></script>


<script src="/js/ocean.js"></script>

</body>
</html>